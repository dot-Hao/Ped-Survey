<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Victoria Harbour Survey</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        /* ================= åŸºç¡€æ ·å¼ ================= */
        body { margin: 0; padding: 0; display: flex; font-family: "Helvetica Neue", Helvetica, "PingFang TC", "Microsoft JhengHei", Arial, sans-serif; height: 100vh; overflow: hidden; color: #333; }

        /* å¸ƒå±€ï¼šå·¦ä¾§é—®å·ï¼Œå³ä¾§åœ°å›¾ */
        #sidebar { width: 400px; background: #f8f9fa; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; display: flex; flex-direction: column; }
        #map { flex-grow: 1; position: relative; }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 50vh; padding: 15px; }
            #map { height: 50vh; width: 100%; }
        }

        h2 { font-size: 1.1rem; margin-top: 0; color: #2c3e50; }
        h3 { font-size: 0.95rem; margin: 15px 0 5px 0; color: #666; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        p { font-size: 0.85rem; color: #666; line-height: 1.4; margin-bottom: 10px; }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .q-item { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .q-label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }

        /* å•é€‰ & å¤šé€‰ */
        .radio-group label, .checkbox-group label { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; cursor: pointer; }
        .radio-group input, .checkbox-group input { margin-right: 8px; accent-color: #007bff; }

        /* çŸ©é˜µé¢˜è¡¨æ ¼ (æ»¡æ„åº¦è¯„åˆ†) */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .matrix-table th, .matrix-table td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
        .matrix-table th:first-child, .matrix-table td:first-child { text-align: left; width: 40%; font-weight: normal; }
        .matrix-table th { background: #f1f3f5; color: #495057; }

        /* æŒ‰é’® */
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; margin-top: auto; font-size: 1rem; }

        /* è¯­è¨€åˆ‡æ¢ */
        .lang-switch { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 15px; }
        .lang-btn { background: none; border: 1px solid #ccc; padding: 4px 10px; font-size: 12px; cursor: pointer; width: auto; margin-top: 0; color: #666; }
        .lang-btn.active { background: #333; color: white; border-color: #333; }

        /* åœ°å›¾çŠ¶æ€ä¸åˆ—è¡¨ */
        .cursor-pen .mapboxgl-canvas-container { cursor: crosshair !important; }
        #stops-list { font-size: 0.85rem; max-height: 150px; overflow-y: auto; margin-top: 5px;}
        .stop-item { background: #fff; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.8rem; display: flex; justify-content: space-between; }
        #status-bar { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 4px; font-size: 13px; text-align: center; pointer-events: none; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="lang-switch">
        <button class="lang-btn" onclick="setLang('en')">English</button>
        <button class="lang-btn active" onclick="setLang('zh-tw')">ç¹é«”ä¸­æ–‡</button>
    </div>

    <h2 id="txt-title">ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥</h2>
    <p id="txt-intro">ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚</p>

    <form id="survey-form">
        <div id="dynamic-form-container"></div>
    </form>

    <div class="q-item" style="border-left: 4px solid #007bff;">
        <label class="q-label" id="lbl-map-task">ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)</label>
        <p style="font-size:12px; color:#666;" id="txt-map-hint">
            1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>
            2. ç•«å®Œå¾Œï¼Œé»æ“Šç·šä¸Šçš„é»æ¨™è¨˜æ‚¨<b>ç¶“éçš„å€åŸŸ</b>æˆ–<b>åœç•™é»</b>ã€‚
        </p>

        <button type="button" id="btn-draw" class="btn-primary">âœï¸ <span id="txt-draw">é–‹å§‹ç¹ªè£½è·¯ç·š</span></button>
        <button type="button" id="btn-clear" class="btn-danger" style="display:none;">ğŸ—‘ï¸ <span id="txt-clear">æ¸…é™¤é‡ç•«</span></button>

        <div id="stops-container" style="margin-top:10px; display:none;">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:5px;">å·²æ¨™è¨˜çš„å€åŸŸ/åœç•™é»ï¼š</div>
            <div id="stops-list"></div>
        </div>
    </div>

    <button type="button" id="btn-submit" class="btn-success">âœ… <span id="txt-submit">æäº¤å•å·</span></button>
    <div style="height: 30px;"></div>
</div>

<div id="map">
    <div id="status-bar">Loading map...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ğŸ”´ 1. å¡«å…¥ä½ çš„ Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyC7VlOkfjsMJyLjeNOfUKRBC7tUKDwBw4c",
        authDomain: "seafrontcorridor.firebaseapp.com",
        databaseURL: "https://seafrontcorridor-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafrontcorridor",
        storageBucket: "seafrontcorridor.firebasestorage.app",
        messagingSenderId: "254023717334",
        appId: "1:254023717334:web:cbb2a9bce184b1d2409477",
        measurementId: "G-DECCS32PFD"
        };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    window.submitToFirebase = async (data) => {
        if (!db) return { success: false, error: "Database not connected" };
        try {
            const docRef = await addDoc(collection(db, "victoria_harbour_survey"), data);
            return { success: true, id: docRef.id };
        } catch (e) {
            return { success: false, error: e.message };
        }
    };
</script>

<script>
    // ==========================================
    // ğŸŸ¢ é—®å·é…ç½® (å®Œå…¨åŸºäº PDF å†…å®¹)
    // ==========================================
    const surveyConfig = [
        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬èµ„æ–™ [cite: 8] ---
        { type: 'header', label: { en: 'Part 1: Demographics', 'zh-tw': 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™' } },
        {
            id: 'age', type: 'radio',
            label: { en: '1. What is your age group?', 'zh-tw': '1. æ‚¨çš„å¹´é½¡æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '18-30', text: { en: '18-30', 'zh-tw': '18-30æ­²' } },
                { val: '31-50', text: { en: '31-50', 'zh-tw': '31-50æ­²' } },
                { val: '51-65', text: { en: '51-65', 'zh-tw': '51-65æ­²' } },
                { val: '65+', text: { en: 'Over 65', 'zh-tw': '65æ­²ä»¥ä¸Š' } }
            ]
        },
        {
            id: 'gender', type: 'radio',
            label: { en: '2. Gender', 'zh-tw': '2. æ‚¨çš„æ€§åˆ¥ï¼š' },
            options: [
                { val: 'M', text: { en: 'Male', 'zh-tw': 'ç”·' } },
                { val: 'F', text: { en: 'Female', 'zh-tw': 'å¥³' } }
            ]
        },
        {
            id: 'identity', type: 'radio',
            label: { en: '3. Residency status', 'zh-tw': '3. æ‚¨çš„èº«ä»½æ˜¯ï¼Ÿ' },
            options: [
                { val: 'Resident', text: { en: 'HK Resident', 'zh-tw': 'é¦™æ¸¯å±…æ°‘' } },
                { val: 'Tourist', text: { en: 'Tourist', 'zh-tw': 'éŠå®¢' } }
            ]
        },

        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è®¿é—®ä¿¡æ¯ [cite: 20] ---
        { type: 'header', label: { en: 'Part 2: Basic Visit Info', 'zh-tw': 'ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è¨ªå•è³‡è¨Š' } },
        {
            id: 'frequency', type: 'radio',
            label: { en: '1. Visit frequency', 'zh-tw': '1. æ‚¨è¨ªå•æµ·æ¿±é•·å»Šçš„é »ç‡æ˜¯ï¼Ÿ' },
            options: [
                { val: 'daily', text: { en: 'Almost daily', 'zh-tw': 'å¹¾ä¹æ¯å¤©' } },
                { val: '3-4w', text: { en: '3-4 times/week', 'zh-tw': 'æ¯å‘¨3-4æ¬¡' } },
                { val: '1-2w', text: { en: '1-2 times/week', 'zh-tw': 'æ¯å‘¨1-2æ¬¡' } },
                { val: '1-2m', text: { en: '1-2 times/month', 'zh-tw': 'æ¯æœˆ1-2æ¬¡' } },
                { val: 'rarely', text: { en: 'Rarely', 'zh-tw': 'å¾ˆå°‘' } }
            ]
        },
        {
            id: 'day', type: 'radio',
            label: { en: '2. Visit day', 'zh-tw': '2. æ‚¨ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ä¾†è¨ªï¼Ÿ' },
            options: [
                { val: 'weekday', text: { en: 'Weekday', 'zh-tw': 'å·¥ä½œæ—¥' } },
                { val: 'weekend', text: { en: 'Weekend/Holiday', 'zh-tw': 'é€±æœ«æˆ–å…¬çœ¾å‡æœŸ' } }
            ]
        },
        {
            id: 'arrival_time', type: 'radio', // PDF [cite: 30]
            label: { en: '3. Arrival time', 'zh-tw': '3. æ‚¨åˆ°é”é€™è£¡çš„å…·é«”æ™‚é–“æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '12-14', text: { en: '12:00-14:00', 'zh-tw': '12:00-14:00 (åˆé–“)' } },
                { val: '14-17', text: { en: '14:00-17:00', 'zh-tw': '14:00-17:00 (ä¸‹åˆ)' } },
                { val: '17-19', text: { en: '17:00-19:00', 'zh-tw': '17:00-19:00 (å‚æ™š)' } },
                { val: 'other', text: { en: 'Other', 'zh-tw': 'å…¶ä»–æ™‚é–“' } }
            ]
        },

        // --- ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ [cite: 42] ---
        { type: 'header', label: { en: 'Part 3: Activities', 'zh-tw': 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡èˆ‡åœç•™' } },
        {
            id: 'purpose', type: 'checkbox', // å¤šé€‰
            label: { en: '1. Main purpose (Multiple)', 'zh-tw': '1. æ‚¨ä»Šå¤©ä¸»è¦çš„æ´»å‹•ç›®çš„æ˜¯ï¼Ÿ(å¯å¤šé¸)' },
            options: [
                { val: 'walk', text: { en: 'Strolling', 'zh-tw': 'æ•£æ­¥/é–’é€›' } },
                { val: 'run', text: { en: 'Running', 'zh-tw': 'è·‘æ­¥/é›ç…‰' } },
                { val: 'rest', text: { en: 'Resting', 'zh-tw': 'ä¼‘æ¯/ç™¼å‘†' } },
                { val: 'pass', text: { en: 'Commuting', 'zh-tw': 'é€šå‹¤(è·¯é)' } },
                { val: 'photo', text: { en: 'Photography', 'zh-tw': 'æ¬£è³é¢¨æ™¯/æ‹ç…§' } }
            ]
        },
        // Q2 & Q3 æ˜¯åœ°å›¾é¢˜ï¼Œå•ç‹¬åœ¨ HTML ä¸‹æ–¹å¤„ç†
        {
            id: 'rest_spot', type: 'checkbox', // [cite: 66]
            label: { en: '4. Preferred resting spot', 'zh-tw': '4. å¦‚æœåœä¸‹ä¾†ä¼‘æ¯ï¼Œé€šå¸¸é¸æ“‡å“ªè£¡ï¼Ÿ' },
            options: [
                { val: 'bench', text: { en: 'Bench', 'zh-tw': 'é•·æ¤…æˆ–åº§æ¤…å€' } },
                { val: 'lawn', text: { en: 'Lawn', 'zh-tw': 'è‰åªæˆ–ç¶ åœ°' } },
                { val: 'railing', text: { en: 'By railing', 'zh-tw': 'é è¿‘æ¬„æ†çš„æµ·é‚Š' } },
                { val: 'shade', text: { en: 'Under shade', 'zh-tw': 'æ¨¹è”­ä¸‹' } },
                { val: 'art', text: { en: 'Near art', 'zh-tw': 'è—è¡“è£ç½®é™„è¿‘' } }
            ]
        },

        // --- ç¬¬å››éƒ¨åˆ†ï¼šç¯å¢ƒæ„ŸçŸ¥ [cite: 73] ---
        { type: 'header', label: { en: 'Part 4: Perception', 'zh-tw': 'ç¬¬å››éƒ¨åˆ†ï¼šç’°å¢ƒæ„ŸçŸ¥èˆ‡è©•åƒ¹' } },
        {
            id: 'reason_visit', type: 'checkbox', // åˆå¹¶äº† Q1 å’Œ Q2ï¼Œç®€åŒ–é€»è¾‘
            label: { en: '1&2. Reason for visiting at this time (Optional)', 'zh-tw': '1&2. æ‚¨é¸æ“‡ç¾åœ¨ä¾†è¨ªä¸»è¦æ˜¯å› ç‚ºï¼Ÿ(å¯å¤šé¸)' },
            options: [
                { val: 'sun', text: { en: 'Sunlight', 'zh-tw': 'äº«å—é™½å…‰' } },
                { val: 'cool', text: { en: 'Cooler temp', 'zh-tw': 'æ°£æº«èˆ’é©/è¼ƒæ¶¼çˆ½' } },
                { val: 'lunch', text: { en: 'Lunch break', 'zh-tw': 'åˆä¼‘ä¾¿åˆ©' } },
                { val: 'nightview', text: { en: 'Night view', 'zh-tw': 'å¤œæ™¯/ç‡ˆå…‰' } },
                { val: 'sunset', text: { en: 'Sunset', 'zh-tw': 'è§€è³æ—¥è½' } }
            ]
        },
        {
            id: 'satisfaction', type: 'matrix', // çŸ©é˜µé¢˜ [cite: 84]
            label: { en: '3. Satisfaction Rating (1-5)', 'zh-tw': '3. è«‹å°ã€Œè¨­æ–½èˆ‡ç’°å¢ƒã€æ»¿æ„åº¦è©•åˆ† (1-5åˆ†)' },
            rows: [
                { id: 'seat', text: { en: 'Seating', 'zh-tw': 'åº§æ¤…æ•¸é‡èˆ‡èˆ’é©åº¦' } },
                { id: 'shade', text: { en: 'Shading', 'zh-tw': 'é®é™½/é®é›¨è¨­æ–½' } },
                { id: 'green', text: { en: 'Greenery', 'zh-tw': 'ç¶ åŒ–æ™¯è§€' } },
                { id: 'seaview', text: { en: 'Sea view', 'zh-tw': 'è¦ªæµ·è¦–é‡' } },
                { id: 'art', text: { en: 'Art', 'zh-tw': 'è—è¡“èˆ‡äº’å‹•è£ç½®' } },
                { id: 'commercial', text: { en: 'Facilities', 'zh-tw': 'å•†æ¥­è¨­æ–½(è²©è³£æ©Ÿç­‰)' } }
            ],
            cols: ['1', '2', '3', '4', '5']
        },
        {
            id: 'attraction', type: 'radio', // [cite: 87]
            label: { en: '4. Factor for staying long', 'zh-tw': '4. å“ªå€‹å› ç´ æœ€èƒ½å¸å¼•æ‚¨é•·æ™‚é–“åœç•™ï¼Ÿ' },
            options: [
                { val: 'view', text: { en: 'Sea view', 'zh-tw': 'å¯¬é—Šçš„æµ·æ™¯' } },
                { val: 'green', text: { en: 'Greenery', 'zh-tw': 'è±å¯Œçš„ç¶ æ¤' } },
                { val: 'seat', text: { en: 'Comfort', 'zh-tw': 'èˆ’é©çš„åº§æ¤…' } },
                { val: 'art', text: { en: 'Art', 'zh-tw': 'ç¨ç‰¹çš„è—è¡“è£ç½®' } },
                { val: 'shade', text: { en: 'Shade', 'zh-tw': 'é®é™½é¿æš‘' } }
            ]
        }
    ];

    // ==========================================
    // æ¸²æŸ“è¡¨å•é€»è¾‘
    // ==========================================
    let currentLang = 'zh-tw';

    function renderForm() {
        const container = document.getElementById('dynamic-form-container');
        container.innerHTML = '';

        surveyConfig.forEach(q => {
            if (q.type === 'header') {
                const h3 = document.createElement('h3');
                h3.innerText = q.label[currentLang];
                container.appendChild(h3);
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'q-item';

            const label = document.createElement('label');
            label.className = 'q-label';
            label.innerText = q.label[currentLang];
            wrapper.appendChild(label);

            // å•é€‰ Radio
            if (q.type === 'radio') {
                const group = document.createElement('div');
                group.className = 'radio-group';
                q.options.forEach(opt => {
                    const l = document.createElement('label');
                    l.innerHTML = `<input type="radio" name="${q.id}" value="${opt.val}"> ${opt.text[currentLang]}`;
                    group.appendChild(l);
                });
                wrapper.appendChild(group);
            }
            // å¤šé€‰ Checkbox
            else if (q.type === 'checkbox') {
                const group = document.createElement('div');
                group.className = 'checkbox-group';
                q.options.forEach(opt => {
                    const l = document.createElement('label');
                    l.innerHTML = `<input type="checkbox" name="${q.id}" value="${opt.val}"> ${opt.text[currentLang]}`;
                    group.appendChild(l);
                });
                wrapper.appendChild(group);
            }
            // çŸ©é˜µ Matrix
            else if (q.type === 'matrix') {
                const table = document.createElement('table');
                table.className = 'matrix-table';

                // è¡¨å¤´
                const thead = document.createElement('tr');
                thead.innerHTML = `<th>è¦ç´ </th>${q.cols.map(c => `<th>${c}</th>`).join('')}`;
                table.appendChild(thead);

                // è¡Œ
                q.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    let tds = `<td>${row.text[currentLang]}</td>`;
                    q.cols.forEach(colVal => {
                        tds += `<td><input type="radio" name="${q.id}_${row.id}" value="${colVal}"></td>`;
                    });
                    tr.innerHTML = tds;
                    table.appendChild(tr);
                });
                wrapper.appendChild(table);
            }

            container.appendChild(wrapper);
        });
    }

    // è¯­è¨€åˆ‡æ¢é€»è¾‘
    window.setLang = (lang) => {
        currentLang = lang;
        renderForm();

        // æ›´æ–°å›ºå®šæ–‡æœ¬
        const texts = {
            'en': { title: "Survey on Victoria Harbour Promenade", intro: "This study aims to understand user behavior and experience.", map: "Part 3: Activity Trajectory (Draw on Map)", mapHint: "1. Click 'Start Drawing' to trace your route.\n2. Click on the line to mark spots visited.", draw: "Start Drawing", clear: "Redraw", submit: "Submit Survey" },
            'zh-tw': { title: "ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥", intro: "ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚", map: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)", mapHint: "1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>2. ç•«å®Œå¾Œï¼Œé»æ“Šç·šä¸Šçš„é»æ¨™è¨˜æ‚¨<b>ç¶“éçš„å€åŸŸ</b>æˆ–<b>åœç•™é»</b>ã€‚", draw: "é–‹å§‹ç¹ªè£½è·¯ç·š", clear: "æ¸…é™¤é‡ç•«", submit: "æäº¤å•å·" }
        };
        document.getElementById('txt-title').innerText = texts[lang].title;
        document.getElementById('txt-intro').innerText = texts[lang].intro;
        document.getElementById('lbl-map-task').innerText = texts[lang].map;
        document.getElementById('txt-map-hint').innerHTML = texts[lang].mapHint;
        document.getElementById('txt-draw').innerText = texts[lang].draw;
        document.getElementById('txt-clear').innerText = texts[lang].clear;
        document.getElementById('txt-submit').innerText = texts[lang].submit;

        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="setLang('${lang}')"]`).classList.add('active');
    };

    // ==========================================
    // ğŸ—ºï¸ åœ°å›¾é€»è¾‘ (Mapbox)
    // ==========================================

    // ğŸ”´ 2. å¡«å…¥ä½ çš„ Mapbox Token
    mapboxgl.accessToken = 'pk.eyJ1Ijoiamh3MTExIiwiYSI6ImNtazgybjFyeDFidGczY29laWRtemFkMnoifQ.y1ffbT2LMx4jc8ZT8u9xXg';

    // è®¾ç½®ä¸ºç»´å¤šåˆ©äºšæ¸¯ä¸­å¿ƒ [cite: 31, 52-65]
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [114.16, 22.285], // é¦™æ¸¯ç»´å¤šåˆ©äºšæ¸¯ä¸­å¿ƒ
        zoom: 13,
        pitch: 45, // ç¨å¾®å€¾æ–œï¼Œçœ‹3Dæ•ˆæœæ›´å¥½
    });

    let isDrawing = false, drawMode = false, pathCoordinates = [], stopsData = [];
    const statusBar = document.getElementById('status-bar');

    map.on('load', () => {
        renderForm(); // åˆå§‹åŒ–è¡¨å•

        // æ·»åŠ çº¢è‰²è·¯å¾„å›¾å±‚
        map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
        map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#e74c3c', 'line-width': 5, 'line-opacity': 0.8 } });
        statusBar.innerText = "Ready";
    });

    // ç»˜å›¾æ¨¡å¼åˆ‡æ¢
    document.getElementById('btn-draw').addEventListener('click', () => {
        drawMode = true; map.dragPan.disable();
        document.getElementById('map').classList.add('cursor-pen');
        document.getElementById('btn-draw').style.display = 'none';
        document.getElementById('btn-clear').style.display = 'inline-block';
        statusBar.innerText = "ç¹ªç•«æ¨¡å¼ï¼šè«‹æŒ‰ä½æ»‘é¼ /æ‰‹æŒ‡ç•«å‡ºæ‚¨çš„è¡Œèµ°è·¯ç·š";
    });

    document.getElementById('btn-clear').addEventListener('click', () => {
        pathCoordinates = []; stopsData = [];
        map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } });
        document.querySelectorAll('.mapboxgl-marker').forEach(m => m.remove());
        document.getElementById('stops-list').innerHTML = '';
        document.getElementById('stops-container').style.display = 'none';

        drawMode = false; map.dragPan.enable();
        document.getElementById('map').classList.remove('cursor-pen');
        document.getElementById('btn-draw').style.display = 'inline-block';
        document.getElementById('btn-clear').style.display = 'none';
        statusBar.innerText = "å·²æ¸…é™¤";
    });

    // é¼ æ ‡/è§¦æ‘¸ ç”»çº¿é€»è¾‘
    function handleMove(coords) {
        if (!drawMode || !isDrawing) return;
        pathCoordinates.push(coords);
        map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': pathCoordinates } });
    }

    map.on('mousedown', (e) => { if(drawMode) { isDrawing = true; pathCoordinates = [[e.lngLat.lng, e.lngLat.lat]]; } });
    map.on('mousemove', (e) => handleMove([e.lngLat.lng, e.lngLat.lat]));
    map.on('mouseup', () => endDraw());

    map.getCanvas().addEventListener('touchstart', (e) => {
        if (!drawMode) return; e.preventDefault();
        const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
        isDrawing = true; pathCoordinates = [[loc.lng, loc.lat]];
    }, {passive:false});

    map.getCanvas().addEventListener('touchmove', (e) => {
        if (!drawMode) return; e.preventDefault();
        const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
        handleMove([loc.lng, loc.lat]);
    }, {passive:false});

    map.getCanvas().addEventListener('touchend', () => endDraw());

    function endDraw() {
        if (!isDrawing) return;
        isDrawing = false; drawMode = false; map.dragPan.enable();
        document.getElementById('map').classList.remove('cursor-pen');

        // å¹³æ»‘è·¯å¾„
        if(pathCoordinates.length > 2) {
            const simplified = turf.simplify(turf.lineString(pathCoordinates), {tolerance: 0.0001, highQuality: true});
            pathCoordinates = simplified.geometry.coordinates;
            map.getSource('route').setData(simplified);
        }
        statusBar.innerText = "è·¯å¾‘å·²ç”Ÿæˆï¼Œè«‹é»æ“Šè·¯å¾‘ä¸Šçš„é»æ¨™è¨˜ç¶“éå€åŸŸæˆ–åœç•™é»";
    }

    // æ ‡è®°åœç•™ç‚¹é€»è¾‘ (å¯¹åº” PDF Q2 & Q4)
<!--    map.on('click', (e) => {-->
<!--        if (drawMode || pathCoordinates.length === 0) return;-->

<!--        // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»åœ¨è·¯å¾„é™„è¿‘-->
<!--        const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);-->
<!--        const line = turf.lineString(pathCoordinates);-->
<!--        const dist = turf.pointToLineDistance(pt, line, {units: 'kilometers'});-->

<!--        if (dist > 0.2) { statusBar.innerText = "âš ï¸ è«‹é»æ“Šè·¯å¾‘é™„è¿‘çš„é»"; return; }-->

<!--        const name = prompt(currentLang === 'en' ? "Location Name/Activity:" : "åœ°é»åç¨±/æ´»å‹• (ä¾‹å¦‚: ä¸­å±±å…¬åœ’/ä¼‘æ¯):");-->
<!--        if (!name) return;-->

<!--        new mapboxgl.Marker({ color: '#2ecc71' }).setLngLat(e.lngLat).addTo(map);-->
<!--        stopsData.push({ lng: e.lngLat.lng, lat: e.lngLat.lat, name: name });-->

<!--        document.getElementById('stops-container').style.display = 'block';-->
<!--        const div = document.createElement('div');-->
<!--        div.className = 'stop-item';-->
<!--        div.innerHTML = `<span>ğŸ“ ${name}</span>`;-->
<!--        document.getElementById('stops-list').appendChild(div);-->
<!--    });-->
// ==========================================
    // ğŸ“ æ¨™è¨˜åœç•™é»é‚è¼¯ (æ›´æ–°ç‰ˆï¼šåŠ å…¥åœç•™æ™‚é–“é¸æ“‡)
    // ==========================================
        map.on('click', (e) => {
            if (drawMode || pathCoordinates.length === 0) return;

            // åˆ¤æ–·æ˜¯å¦é»æ“Šåœ¨è·¯å¾‘é™„è¿‘
            const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);
            const line = turf.lineString(pathCoordinates);
            const dist = turf.pointToLineDistance(pt, line, {units: 'kilometers'});

            if (dist > 0.2) {
            statusBar.innerText = currentLang === 'en' ? "âš ï¸ Please click near your path" : "âš ï¸ è«‹é»æ“Šè·¯å¾‘é™„è¿‘çš„é»";
            return;
            }

            // 1. è¼¸å…¥åœ°é»åç¨±
            const name = prompt(currentLang === 'en' ? "Location Name/Activity:" : "åœ°é»åç¨±/æ´»å‹• (ä¾‹å¦‚: ä¸­å±±å…¬åœ’/ä¼‘æ¯):");
            if (!name) return;

            // 2. é¸æ“‡åœç•™æ™‚é–“ (ä½¿ç”¨ prompt æ¨¡æ“¬ç°¡å–®é¸æ“‡)
            const durationPrompt = currentLang === 'en'
                ? "Stay Duration:\n1: 0-10min\n2: 10-20min\n3: 20-30min\n4: 30+min\n(Please enter 1, 2, 3, or 4)"
                : "è«‹é¸æ“‡åœç•™æ™‚é–“ï¼š\n1: 0-10åˆ†é˜\n2: 10-20åˆ†é˜\n3: 20-30åˆ†é˜\n4: 30åˆ†é˜ä»¥ä¸Š\n(è«‹è¼¸å…¥æ•¸å­— 1-4)";

            const durChoice = prompt(durationPrompt, "1");

            // æ™‚é–“æ˜ å°„è¡¨
            const durMap = {
            "1": "0-10min",
            "2": "10-20min",
            "3": "20-30min",
            "4": "30+min"
            };
            const duration = durMap[durChoice] || "0-10min"; // é è¨­ 0-10min

            // 3. æ·»åŠ åˆ°åœ°åœ–èˆ‡æ•¸æ“šè¨˜éŒ„
            new mapboxgl.Marker({ color: '#2ecc71' }).setLngLat(e.lngLat).addTo(map);
            stopsData.push({
            lng: e.lngLat.lng,
            lat: e.lngLat.lat,
            name: name,
            duration: duration // æ–°å¢åœç•™æ™‚é–“æ¬„ä½
            });

            // 4. æ›´æ–°å·¦å´åˆ—è¡¨é¡¯ç¤º
            document.getElementById('stops-container').style.display = 'block';
            const div = document.createElement('div');
            div.className = 'stop-item';
            div.style.flexDirection = 'column'; // è®“åç¨±å’Œæ™‚é–“åˆ†è¡Œæˆ–ç·Šæ¹Šæ’åˆ—
            div.style.alignItems = 'flex-start';

            div.innerHTML = `
                <div style="font-weight:bold;">ğŸ“ ${name}</div>
                <div style="font-size:11px; color:#28a745;">â±ï¸ ${currentLang === 'en' ? 'Stayed' : 'åœç•™'}: ${duration}</div>
            `;
            document.getElementById('stops-list').appendChild(div);

            statusBar.innerText = currentLang === 'en' ? "Stop added" : "åœç•™é»å·²æ¨™è¨˜";
        });

    // ==========================================
    // æäº¤é€»è¾‘
    // ==========================================
    document.getElementById('btn-submit').addEventListener('click', async () => {
        const btn = document.getElementById('btn-submit');

        // 1. æ”¶é›†é—®å·æ•°æ®
        const formData = {};

        // è·å–æ‰€æœ‰ input (radio/checkbox)
        document.querySelectorAll('input:checked').forEach(input => {
            const name = input.name;
            const val = input.value;

            // å¦‚æœæ˜¯çŸ©é˜µé¢˜ (nameé‡Œæœ‰ä¸‹åˆ’çº¿) æˆ– å¤šé€‰é¢˜ï¼Œå­˜ä¸ºæ•°ç»„æˆ–å¯¹è±¡
            if (formData[name]) {
                if (!Array.isArray(formData[name])) formData[name] = [formData[name]];
                formData[name].push(val);
            } else {
                formData[name] = val;
            }
        });

        // 2. éªŒè¯åœ°å›¾æ•°æ® (PDFè¦æ±‚æœ‰è·¯çº¿ [cite: 51])
        if (pathCoordinates.length === 0) {
            alert(currentLang === 'en' ? "Please draw your route on the map!" : "è«‹åœ¨ç¬¬ä¸‰éƒ¨åˆ†ç¹ªè£½æ‚¨çš„è¡Œèµ°è·¯ç·šï¼");
            return;
        }

        btn.disabled = true; btn.innerText = "...";

        // 3. æäº¤
        const result = await window.submitToFirebase({
            answers: formData,
            path: JSON.stringify(pathCoordinates), // è½¬å­—ç¬¦ä¸²å­˜
            stops: stopsData,
            timestamp: new Date().toISOString(),
            lang: currentLang
        });

        if (result.success) {
            alert("æäº¤æˆåŠŸ / Submitted Successfully! ID: " + result.id);
            location.reload();
        } else {
            alert("Error: " + result.error);
            btn.disabled = false; btn.innerText = "Retry";
        }
    });
</script>
</body>
</html>
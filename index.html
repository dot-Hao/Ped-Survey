<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Victoria Harbour Survey</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        /* ================= åŸºç¡€æ ·å¼ ================= */
        body { margin: 0; padding: 0; display: flex; font-family: "Helvetica Neue", Helvetica, "PingFang TC", "PingFang SC", "Microsoft JhengHei", "Microsoft YaHei", Arial, sans-serif; height: 100vh; overflow: hidden; color: #333; }

        /* å¸ƒå±€ï¼šå·¦ä¾§é—®å·ï¼Œå³ä¾§åœ°å›¾ */
        #sidebar { width: 400px; background: #f8f9fa; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; display: flex; flex-direction: column; }
        #map { flex-grow: 1; position: relative; }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 50vh; padding: 15px; }
            #map { height: 50vh; width: 100%; }
        }

        h2 { font-size: 1.1rem; margin-top: 0; color: #2c3e50; }
        h3 { font-size: 0.95rem; margin: 15px 0 5px 0; color: #666; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        p { font-size: 0.85rem; color: #666; line-height: 1.4; margin-bottom: 10px; }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .q-item { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .q-label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }

        /* å•é€‰ & å¤šé€‰ */
        .radio-group label, .checkbox-group label { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; cursor: pointer; }
        .radio-group input, .checkbox-group input { margin-right: 8px; accent-color: #007bff; }

        /* çŸ©é˜µé¢˜è¡¨æ ¼ (æ»¡æ„åº¦è¯„åˆ†) */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .matrix-table th, .matrix-table td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
        .matrix-table th:first-child, .matrix-table td:first-child { text-align: left; width: 40%; font-weight: normal; }
        .matrix-table th { background: #f1f3f5; color: #495057; }

        /* æŒ‰é’® */
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; margin-top: auto; font-size: 1rem; }

        /* è¯­è¨€åˆ‡æ¢ */
        .lang-switch { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 15px; }
        .lang-btn { background: none; border: 1px solid #ccc; padding: 4px 10px; font-size: 12px; cursor: pointer; width: auto; margin-top: 0; color: #666; }
        .lang-btn.active { background: #333; color: white; border-color: #333; }

        /* åœ°å›¾çŠ¶æ€ä¸åˆ—è¡¨ */
        .cursor-pen .mapboxgl-canvas-container { cursor: crosshair !important; }
        #stops-list { font-size: 0.85rem; max-height: 150px; overflow-y: auto; margin-top: 5px;}
        .stop-item { background: #fff; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.8rem; display: flex; justify-content: space-between; }
        #status-bar { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 4px; font-size: 13px; text-align: center; pointer-events: none; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å…¬å‘Šæ æ ·å¼ */
        #announcement-bar { background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ffeeba; display: none; font-size: 0.85rem; }
        /* è°ƒæŸ¥å…³é—­é®ç½© */
        #closed-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; display: none; }

        /* ================= æ–°å¢æ ·å¼ (æ¬¢è¿æ ã€åœ°å›¾æ ‡è®°ã€å¼¹çª—) ================= */
        /* 1. æ¬¢è¿æ¨ªå¹… */
        #welcome-banner {
            background: #fff3cd; border: 1px solid #ffeeba; color: #856404;
            padding: 15px; margin-bottom: 20px; border-radius: 8px;
            display: flex; align-items: center; gap: 10px;
            font-weight: bold; font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #welcome-banner::before { content: "ğŸ“¢"; font-size: 1.5rem; }

        /* --- ä¿®æ”¹ï¼šåœ°åœ–æ¨™è¨˜å„ªåŒ– (ç¸®å°å°ºå¯¸ï¼Œæ›´ç²¾ç·») --- */
        .marker-pin {
            width: 22px;  /* å¾ 30px ç¸®å° */
            height: 22px; /* å¾ 30px ç¸®å° */
            border-radius: 50% 50% 50% 0;
            background: #3498db;
            position: absolute;
            transform: rotate(-45deg); /* ä¿æŒé€™å€‹æ—‹è½‰ä»¥å½¢æˆæ°´æ»´å½¢ç‹€ */
            box-shadow: -2px 3px 4px rgba(0,0,0,0.3); /* é™°å½±ç¸®å° */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin: 0;
        }

        /* åœ–æ¨™å…§éƒ¨çš„ç™½é» (ä¿æŒæ°´å¹³) */
        .marker-pin::after {
            content: '';
            width: 10px;  /* å¾ 14px ç¸®å° */
            height: 10px; /* å¾ 14px ç¸®å° */
            border-radius: 50%;
            background: white;
            transform: rotate(45deg); /* åå‘æ—‹è½‰ï¼Œç¢ºä¿çœ‹èµ·ä¾†æ˜¯åœ“çš„ */
        }

        /* é¡å‹å€åˆ†ï¼šäº¤é€š (æ·±è—è‰²ï¼Œæ›´é¡¯çœ¼) */
        .marker-transport {
            background: #0d6efd;
        }
        /* é¡å‹å€åˆ†ï¼šä¼‘é–’ (æ©™ç´…è‰²ï¼Œæ›´æ´»æ½‘) */
        .marker-leisure {
            background: #fd7e14;
        }

        /* --- ä¿®æ”¹ 4: "å…¶ä»–" é¸é …çš„è¼¸å…¥æ¡†æ¨£å¼ --- */
        .other-input {
            width: 90%;
            margin-top: 5px;
            margin-left: 5px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.85rem;
            display: none; /* é»˜èªéš±è— */
            background: #fff;
        }

        /* 4. åœç•™æ—¶é—´é€‰æ‹©å¼¹çª— */
        #duration-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 10px; width: 300px;
            text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .modal-btn {
            display: block; width: 100%; padding: 10px; margin: 8px 0;
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px;
            cursor: pointer; font-size: 14px; transition: 0.2s;
        }
        .modal-btn:hover { background: #e2e6ea; }
        .modal-title { font-weight: bold; margin-bottom: 15px; color: #333; }

        /* ================== æ–°å¢ï¼šç²¾ç¾ POI ä¿¡æ¯å¡ç‰‡æ¨£å¼ ================== */
        .mapboxgl-popup-content {
            padding: 0 !important; /* æ¸…é™¤é»˜èªå…§é‚Šè· */
            border-radius: 12px !important; /* åœ“è§’å¡ç‰‡ */
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
            min-width: 220px;
            max-width: 250px;
            font-family: "Helvetica Neue", Arial, sans-serif;
        }

        .poi-card {
            display: flex;
            flex-direction: column;
        }

        .poi-image {
            width: 100%;
            height: 120px; /* åœ–ç‰‡é«˜åº¦ */
            object-fit: cover; /* ä¿æŒåœ–ç‰‡æ¯”ä¾‹å¡«å…… */
            background-color: #eee; /* åœ–ç‰‡åŠ è¼‰å‰çš„èƒŒæ™¯è‰² */
        }

        .poi-info {
            padding: 12px 15px;
            text-align: left;
        }

        .poi-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .poi-tag {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            letter-spacing: 0.5px;
        }

        .poi-desc {
            font-size: 12px;
            color: #666;
            margin-top: 6px;
            line-height: 1.4;
        }

        /* èª¿æ•´ Mapbox é»˜èªé—œé–‰æŒ‰éˆ•çš„é¡è‰²ï¼Œä½¿å…¶åœ¨åœ–ç‰‡ä¸Šå¯è¦‹ */
        .mapboxgl-popup-close-button {
            color: white;
            font-size: 20px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.6);
            z-index: 10;
            top: 5px;
            right: 5px;
        }
        .mapboxgl-popup-close-button:hover {
            background-color: rgba(0,0,0,0.1);
            border-radius: 50%;
        }
    </style>
</head>
<body>

<!-- è°ƒæŸ¥å…³é—­æç¤ºå±‚ -->
<div id="closed-mask">
    <h2>ğŸ”’ Survey Closed / èª¿æŸ¥å·²çµæŸ</h2>
    <p>Thank you for your interest.</p>
</div>
<!-- å·²å®Œæˆä»Šæ—¥è°ƒæŸ¥çš„æç¤º -->
<div id="submitted-mask" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; display: none;">
    <h2 style="font-size: 2rem; color: #28a745; margin-bottom: 10px;">âœ…</h2>
    <h2 style="color: #333;">Thank You! / æ„Ÿè¬åƒèˆ‡</h2>
    <p style="color: #666; padding: 0 20px;">
        You have already submitted the survey today.<br>
        æ‚¨ä»Šå¤©å·²ç¶“å¡«å¯«éå•å·äº†ï¼Œæ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ã€‚
    </p>
</div>

<div id="sidebar">
    <div class="lang-switch">
        <button class="lang-btn" onclick="setLang('en')">English</button>
        <button class="lang-btn active" onclick="setLang('zh-tw')">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLang('zh-cn')">ç®€ä½“ä¸­æ–‡</button>
    </div>
    <div id="welcome-banner">æ­¡è¿åƒåŠ èª¿æŸ¥</div>
    <!-- å…¬å‘Šæ  -->
    <div id="announcement-bar"></div>

    <h2 id="txt-title">ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥</h2>
    <p id="txt-intro">ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚</p>

    <form id="survey-form">
        <div id="dynamic-form-container"></div>
    </form>

    <div class="q-item" style="border-left: 4px solid #007bff;">
        <label class="q-label" id="lbl-map-task">ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)</label>
        <p style="font-size:12px; color:#666;" id="txt-map-hint">
            1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>
            2. ç•«å®Œå¾Œï¼Œé»æ“Šç·šä¸Šçš„é»æ¨™è¨˜æ‚¨<b>ç¶“éçš„å€åŸŸ</b>æˆ–<b>åœç•™é»</b>ã€‚
        </p>

        <div id="draw-controls">
            <button type="button" id="btn-draw" class="btn-primary">âœï¸ <span id="txt-draw">é–‹å§‹ç¹ªè£½è·¯ç·š</span></button>

            <div id="drawing-actions" style="display:none; gap:5px;">
                <button type="button" id="btn-toggle-pan" class="btn-primary" style="background:#6c757d;">âœ‹ <span id="txt-pan">æš«åœç¹ªç•« (ç§»å‹•åœ°åœ–)</span></button>
                <button type="button" id="btn-finish-draw" class="btn-success">âœ… <span id="txt-finish">å®Œæˆç¹ªè£½</span></button>
                <button type="button" id="btn-clear" class="btn-danger">ğŸ—‘ï¸ <span id="txt-clear">æ¸…é™¤é‡ç•«</span></button>
            </div>
        </div>

        <div id="stops-container" style="margin-top:10px; display:none;">
            <div id="stops-list"></div>
        </div>

        <button type="button" id="btn-submit" class="btn-success">âœ… <span id="txt-submit">æäº¤å•å·</span></button>
        <div style="height: 30px;"></div>
    </div> </div> <div id="map">
    <div id="status-bar">Loading map...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ğŸ”´ 1. å¡«å…¥ä½ çš„ Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyC7VlOkfjsMJyLjeNOfUKRBC7tUKDwBw4c",
        authDomain: "seafrontcorridor.firebaseapp.com",
        databaseURL: "https://seafrontcorridor-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafrontcorridor",
        storageBucket: "seafrontcorridor.firebasestorage.app",
        messagingSenderId: "254023717334",
        appId: "1:254023717334:web:cbb2a9bce184b1d2409477",
        measurementId: "G-DECCS32PFD"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    window.submitToFirebase = async (data) => {
        if (!db) return { success: false, error: "Database not connected" };
        try {
            const docRef = await addDoc(collection(db, "victoria_harbour_survey"), data);
            return { success: true, id: docRef.id };
        } catch (e) {
            return { success: false, error: e.message };
        }
    };

    window.fetchSurveyConfig = async () => {
        if (!db) return null;
        try {
            const docRef = doc(db, "config", "survey_settings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                return null;
            }
        } catch (e) {
            console.error("Error fetching config:", e);
            return null;
        }
    };
</script>

<div id="duration-modal">
    <div class="modal-content">
        <div class="modal-title" id="modal-title-text">Please select duration</div>
        <button class="modal-btn" onclick="confirmDuration('0-10min')">0 - 10 min</button>
        <button class="modal-btn" onclick="confirmDuration('10-20min')">10 - 20 min</button>
        <button class="modal-btn" onclick="confirmDuration('20-30min')">20 - 30 min</button>
        <button class="modal-btn" onclick="confirmDuration('30+min')"> > 30 min</button>
        <button class="modal-btn" style="color:red; border-color:#ffcccc;" onclick="closeDurationModal()">Cancel / å–æ¶ˆ</button>
    </div>
</div>

<script>
    // --- ğŸ”¨ å¼·åˆ¶æ¸…é™¤é‡è¤‡ Banner ---
    document.addEventListener("DOMContentLoaded", () => {
        const banners = document.querySelectorAll("div");
        let foundFirst = false;
        banners.forEach(div => {
            // å°‹æ‰¾åŒ…å«è©²æ–‡å­—çš„ div
            if (div.innerText.includes("æ­¡è¿åƒåŠ èª¿æŸ¥") || div.innerText.includes("æ¬¢è¿å‚åŠ è°ƒæŸ¥")) {
                // ä¿ç•™åŸæœ¬æœ‰ ID çš„é‚£å€‹ï¼Œåˆªé™¤å…¶ä»–çš„
                if (div.id === "welcome-banner") {
                    foundFirst = true;
                } else if (!div.querySelector('button') && !div.classList.contains('q-item')) {
                    // åˆªé™¤æ²’æœ‰ ID ä¸”ä¸æ˜¯å•å·å…§å®¹çš„é‡è¤‡é …
                    div.style.display = 'none';
                    console.log("å·²è‡ªå‹•éš±è—é‡è¤‡çš„ Banner");
                }
            }
        });
    });
    // ==========================================
    // ğŸ› ï¸ ä¿®æ”¹ä½ç½® 1ï¼šç¡®ä¿æœ‰è¿™ä¸ªç»Ÿä¸€çš„è·å–æ—¥æœŸå‡½æ•°
    // ==========================================
    function getLocalTodayDate() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`; // è¿”å›æ ¼å¼ä¾‹å¦‚ "2026-01-17"
    }
    // ==========================================
    // ğŸŸ¢ é—®å·é…ç½® (å¢åŠ ç®€ä½“ä¸­æ–‡ zh-cn)
    // ==========================================
    const surveyConfig = [
        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬èµ„æ–™ ---
        { type: 'header', label: { en: 'Part 1: Demographics', 'zh-tw': 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™', 'zh-cn': 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬èµ„æ–™' } },
        {
            id: 'age', type: 'radio',
            label: { en: '1. What is your age group?', 'zh-tw': '1. æ‚¨çš„å¹´é½¡æ®µæ˜¯ï¼Ÿ', 'zh-cn': '1. æ‚¨çš„å¹´é¾„æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '18-30', text: { en: '18-30', 'zh-tw': '18-30æ­²', 'zh-cn': '18-30å²' } },
                { val: '31-50', text: { en: '31-50', 'zh-tw': '31-50æ­²', 'zh-cn': '31-50å²' } },
                { val: '51-65', text: { en: '51-65', 'zh-tw': '51-65æ­²', 'zh-cn': '51-65å²' } },
                { val: '65+', text: { en: 'Over 65', 'zh-tw': '65æ­²ä»¥ä¸Š', 'zh-cn': '65å²ä»¥ä¸Š' } }
            ]
        },
        {
            id: 'gender', type: 'radio',
            label: { en: '2. Gender', 'zh-tw': '2. æ‚¨çš„æ€§åˆ¥ï¼š', 'zh-cn': '2. æ‚¨çš„æ€§åˆ«ï¼š' },
            options: [
                { val: 'M', text: { en: 'Male', 'zh-tw': 'ç”·', 'zh-cn': 'ç”·' } },
                { val: 'F', text: { en: 'Female', 'zh-tw': 'å¥³', 'zh-cn': 'å¥³' } }
            ]
        },
        {
            id: 'identity', type: 'radio',
            label: { en: '3. Residency status', 'zh-tw': '3. æ‚¨çš„èº«ä»½æ˜¯ï¼Ÿ', 'zh-cn': '3. æ‚¨çš„èº«ä»½æ˜¯ï¼Ÿ' },
            options: [
                { val: 'Resident', text: { en: 'HK Resident', 'zh-tw': 'é¦™æ¸¯å±…æ°‘', 'zh-cn': 'é¦™æ¸¯å±…æ°‘' } },
                { val: 'Tourist', text: { en: 'Tourist', 'zh-tw': 'éŠå®¢', 'zh-cn': 'æ¸¸å®¢' } }
            ]
        },

        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è®¿é—®ä¿¡æ¯ ---
        { type: 'header', label: { en: 'Part 2: Basic Visit Info', 'zh-tw': 'ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è¨ªå•è³‡è¨Š', 'zh-cn': 'ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è®¿é—®ä¿¡æ¯' } },
        {
            id: 'frequency', type: 'radio',
            label: { en: '1. Visit frequency', 'zh-tw': '1. æ‚¨è¨ªå•æµ·æ¿±é•·å»Šçš„é »ç‡æ˜¯ï¼Ÿ', 'zh-cn': '1. æ‚¨è®¿é—®æµ·æ»¨é•¿å»Šçš„é¢‘ç‡æ˜¯ï¼Ÿ' },
            options: [
                { val: 'daily', text: { en: 'Almost daily', 'zh-tw': 'å¹¾ä¹æ¯å¤©', 'zh-cn': 'å‡ ä¹æ¯å¤©' } },
                { val: '3-4w', text: { en: '3-4 times/week', 'zh-tw': 'æ¯å‘¨3-4æ¬¡', 'zh-cn': 'æ¯å‘¨3-4æ¬¡' } },
                { val: '1-2w', text: { en: '1-2 times/week', 'zh-tw': 'æ¯å‘¨1-2æ¬¡', 'zh-cn': 'æ¯å‘¨1-2æ¬¡' } },
                { val: '1-2m', text: { en: '1-2 times/month', 'zh-tw': 'æ¯æœˆ1-2æ¬¡', 'zh-cn': 'æ¯æœˆ1-2æ¬¡' } },
                { val: 'rarely', text: { en: 'Rarely', 'zh-tw': 'å¾ˆå°‘', 'zh-cn': 'å¾ˆå°‘' } }
            ]
        },
        {
            id: 'day', type: 'radio',
            label: { en: '2. Visit day', 'zh-tw': '2. æ‚¨ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ä¾†è¨ªï¼Ÿ', 'zh-cn': '2. æ‚¨ä»Šå¤©æ˜¯æ˜ŸæœŸå‡ æ¥è®¿ï¼Ÿ' },
            options: [
                { val: 'weekday', text: { en: 'Weekday', 'zh-tw': 'å·¥ä½œæ—¥', 'zh-cn': 'å·¥ä½œæ—¥' } },
                { val: 'weekend', text: { en: 'Weekend/Holiday', 'zh-tw': 'é€±æœ«æˆ–å…¬çœ¾å‡æœŸ', 'zh-cn': 'å‘¨æœ«æˆ–å…¬ä¼—å‡æœŸ' } }
            ]
        },
        {
            id: 'arrival_time', type: 'radio',
            label: { en: '3. Arrival time', 'zh-tw': '3. æ‚¨åˆ°é”é€™è£¡çš„å…·é«”æ™‚é–“æ®µæ˜¯ï¼Ÿ', 'zh-cn': '3. æ‚¨åˆ°è¾¾è¿™é‡Œçš„å…·ä½“æ—¶é—´æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '12-14', text: { en: '12:00-14:00', 'zh-tw': '12:00-14:00 (åˆé–“)', 'zh-cn': '12:00-14:00 (åˆé—´)' } },
                { val: '14-17', text: { en: '14:00-17:00', 'zh-tw': '14:00-17:00 (ä¸‹åˆ)', 'zh-cn': '14:00-17:00 (ä¸‹åˆ)' } },
                { val: '17-19', text: { en: '17:00-19:00', 'zh-tw': '17:00-19:00 (å‚æ™š)', 'zh-cn': '17:00-19:00 (å‚æ™š)' } },
                { val: 'other', text: { en: 'Other', 'zh-tw': 'å…¶ä»–æ™‚é–“', 'zh-cn': 'å…¶ä»–æ—¶é—´' } }
            ]
        },

        // --- ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ ---
        { type: 'header', label: { en: 'Part 3: Activities', 'zh-tw': 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡èˆ‡åœç•™', 'zh-cn': 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ä¸åœç•™' } },
        {
            id: 'purpose', type: 'checkbox',
            label: { en: '1. Main purpose (Multiple)', 'zh-tw': '1. æ‚¨ä»Šå¤©ä¸»è¦çš„æ´»å‹•ç›®çš„æ˜¯ï¼Ÿ(å¯å¤šé¸)', 'zh-cn': '1. æ‚¨ä»Šå¤©ä¸»è¦çš„æ´»åŠ¨ç›®çš„æ˜¯ï¼Ÿ(å¯å¤šé€‰)' },
            options: [
                { val: 'walk', text: { en: 'Strolling', 'zh-tw': 'æ•£æ­¥/é–’é€›', 'zh-cn': 'æ•£æ­¥/é—²é€›' } },
                { val: 'run', text: { en: 'Running', 'zh-tw': 'è·‘æ­¥/é›ç…‰', 'zh-cn': 'è·‘æ­¥/é”»ç‚¼' } },
                { val: 'rest', text: { en: 'Resting', 'zh-tw': 'ä¼‘æ¯/ç™¼å‘†', 'zh-cn': 'ä¼‘æ¯/å‘å‘†' } },
                { val: 'pass', text: { en: 'Commuting', 'zh-tw': 'é€šå‹¤(è·¯é)', 'zh-cn': 'é€šå‹¤(è·¯è¿‡)' } },
                { val: 'photo', text: { en: 'Photography', 'zh-tw': 'æ¬£è³é¢¨æ™¯/æ‹ç…§', 'zh-cn': 'æ¬£èµé£æ™¯/æ‹ç…§' } }
            ]
        },
        {
            id: 'rest_spot', type: 'checkbox',
            label: { en: '4. Preferred resting spot(Multiple)', 'zh-tw': '4. å¦‚æœåœä¸‹ä¾†ä¼‘æ¯ï¼Œé€šå¸¸é¸æ“‡å“ªè£¡ï¼Ÿ(å¯å¤šé¸)', 'zh-cn': '4. å¦‚æœåœä¸‹æ¥ä¼‘æ¯ï¼Œé€šå¸¸é€‰æ‹©å“ªé‡Œï¼Ÿ(å¯å¤šé€‰)' },
            options: [
                { val: 'bench', text: { en: 'Bench', 'zh-tw': 'é•·æ¤…æˆ–åº§æ¤…å€', 'zh-cn': 'é•¿æ¤…æˆ–åº§æ¤…åŒº' } },
                { val: 'lawn', text: { en: 'Lawn', 'zh-tw': 'è‰åªæˆ–ç¶ åœ°', 'zh-cn': 'è‰åªæˆ–ç»¿åœ°' } },
                { val: 'railing', text: { en: 'By railing', 'zh-tw': 'é è¿‘æ¬„æ†çš„æµ·é‚Š', 'zh-cn': 'é è¿‘æ æ†çš„æµ·è¾¹' } },
                { val: 'shade', text: { en: 'Under shade', 'zh-tw': 'æ¨¹è”­ä¸‹', 'zh-cn': 'æ ‘è«ä¸‹' } },
                { val: 'art', text: { en: 'Near art', 'zh-tw': 'è—è¡“è£ç½®é™„è¿‘', 'zh-cn': 'è‰ºæœ¯è£…ç½®é™„è¿‘' } }
            ]
        },

        // --- ç¬¬å››éƒ¨åˆ†ï¼šç¯å¢ƒæ„ŸçŸ¥ (å·²ä¿®æ”¹ï¼šåˆå¹¶é¢˜ç›®) ---
        { type: 'header', label: { en: 'Part 4: Perception', 'zh-tw': 'ç¬¬å››éƒ¨åˆ†ï¼šç’°å¢ƒæ„ŸçŸ¥èˆ‡è©•åƒ¹', 'zh-cn': 'ç¬¬å››éƒ¨åˆ†ï¼šç¯å¢ƒæ„ŸçŸ¥ä¸è¯„ä»·' } },
        {
            id: 'combined_factors', type: 'checkbox', // åˆå¹¶åçš„å¤šé€‰é¢˜
            label: {
                en: '1. Main reasons for visit or stay (Multiple)',
                'zh-tw': '1. æ‚¨é¸æ“‡ç¾åœ¨ä¾†è¨ªæˆ–é•·æ™‚é–“åœç•™çš„ä¸»è¦åŸå› æ˜¯ï¼Ÿ(å¯å¤šé¸)',
                'zh-cn': '1. æ‚¨é€‰æ‹©ç°åœ¨æ¥è®¿æˆ–é•¿æ—¶é—´åœç•™çš„ä¸»è¦åŸå› æ˜¯ï¼Ÿ(å¯å¤šé€‰)'
            },
            options: [
                { val: 'sun', text: { en: 'Enjoy Sun', 'zh-tw': 'äº«å—é™½å…‰', 'zh-cn': 'äº«å—é˜³å…‰' } },
                { val: 'cool', text: { en: 'Comfortable Temp', 'zh-tw': 'æ°£æº«èˆ’é©/è¼ƒæ¶¼çˆ½', 'zh-cn': 'æ°”æ¸©èˆ’é€‚/è¾ƒå‡‰çˆ½' } },
                { val: 'lunch', text: { en: 'Lunch Convenience', 'zh-tw': 'åˆä¼‘ä¾¿åˆ©', 'zh-cn': 'åˆä¼‘ä¾¿åˆ©' } },
                { val: 'nightview', text: { en: 'Night view/Lights', 'zh-tw': 'å¤œæ™¯/ç‡ˆå…‰', 'zh-cn': 'å¤œæ™¯/ç¯å…‰' } },
                { val: 'sunset', text: { en: 'Sunset', 'zh-tw': 'è§€è³æ—¥è½', 'zh-cn': 'è§‚èµæ—¥è½' } },
                { val: 'seaview', text: { en: 'Sea view', 'zh-tw': 'å¯¬é—Šçš„æµ·æ™¯', 'zh-cn': 'å®½é˜”çš„æµ·æ™¯' } },
                { val: 'green', text: { en: 'Greenery', 'zh-tw': 'è±å¯Œçš„ç¶ æ¤', 'zh-cn': 'ä¸°å¯Œçš„ç»¿æ¤' } },
                { val: 'seat', text: { en: 'Comfortable Seats', 'zh-tw': 'èˆ’é©çš„åº§æ¤…', 'zh-cn': 'èˆ’é€‚çš„åº§æ¤…' } },
                { val: 'art', text: { en: 'Art Installations', 'zh-tw': 'ç¨ç‰¹çš„è—è¡“è£ç½®', 'zh-cn': 'ç‹¬ç‰¹çš„è‰ºæœ¯è£…ç½®' } },
                { val: 'shade', text: { en: 'Shade', 'zh-tw': 'é®é™½é¿æš‘', 'zh-cn': 'é®é˜³é¿æš‘' } }
            ]
        },
        {
            id: 'satisfaction', type: 'matrix',
            label: { en: '2. Satisfaction Rating (1-5)', 'zh-tw': '2. è«‹å°ã€Œè¨­æ–½èˆ‡ç’°å¢ƒã€æ»¿æ„åº¦è©•åˆ† (1-5åˆ†)', 'zh-cn': '2. è¯·å¯¹â€œè®¾æ–½ä¸ç¯å¢ƒâ€æ»¡æ„åº¦è¯„åˆ† (1-5åˆ†)' },
            rows: [
                { id: 'seat', text: { en: 'Seating', 'zh-tw': 'åº§æ¤…æ•¸é‡èˆ‡èˆ’é©åº¦', 'zh-cn': 'åº§æ¤…æ•°é‡ä¸èˆ’é€‚åº¦' } },
                { id: 'shade', text: { en: 'Shading', 'zh-tw': 'é®é™½/é®é›¨è¨­æ–½', 'zh-cn': 'é®é˜³/é®é›¨è®¾æ–½' } },
                { id: 'green', text: { en: 'Greenery', 'zh-tw': 'ç¶ åŒ–æ™¯è§€', 'zh-cn': 'ç»¿åŒ–æ™¯è§‚' } },
                { id: 'seaview', text: { en: 'Sea view', 'zh-tw': 'è¦ªæµ·è¦–é‡', 'zh-cn': 'äº²æµ·è§†é‡' } },
                { id: 'art', text: { en: 'Art', 'zh-tw': 'è—è¡“èˆ‡äº’å‹•è£ç½®', 'zh-cn': 'è‰ºæœ¯ä¸äº’åŠ¨è£…ç½®' } },
                { id: 'commercial', text: { en: 'Facilities', 'zh-tw': 'å•†æ¥­è¨­æ–½(è²©è³£æ©Ÿç­‰)', 'zh-cn': 'å•†ä¸šè®¾æ–½(è´©å–æœºç­‰)' } }
            ],
            cols: ['1', '2', '3', '4', '5']
        }
    ];

    // ==========================================
    // æ¸²æŸ“è¡¨å•é€»è¾‘
    // ==========================================
    let currentLang = 'zh-tw';

    function renderForm() {
        const container = document.getElementById('dynamic-form-container');
        container.innerHTML = '';

        surveyConfig.forEach(q => {
            if (q.type === 'header') {
                const h3 = document.createElement('h3');
                h3.innerText = q.label[currentLang];
                container.appendChild(h3);
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'q-item';

            const label = document.createElement('label');
            label.className = 'q-label';
            label.innerText = q.label[currentLang];
            wrapper.appendChild(label);

            if (q.type === 'radio' || q.type === 'checkbox') {
                const group = document.createElement('div');
                group.className = q.type + '-group'; // radio-group æˆ– checkbox-group

                q.options.forEach(opt => {
                    const l = document.createElement('label');
                    // ç›£è½é»æ“Šäº‹ä»¶ï¼Œè™•ç† "å…¶ä»–" è¼¸å…¥æ¡†
                    const onchangeStr = `handleOptionChange(this, '${q.id}', '${opt.val}')`;

                    l.innerHTML = `<input type="${q.type}" name="${q.id}" value="${opt.val}" onchange="${onchangeStr}"> ${opt.text[currentLang]}`;

                    // ä¿®æ”¹ 4: å¦‚æœæ˜¯ "other" é¸é …ï¼Œæ·»åŠ ä¸€å€‹è¼¸å…¥æ¡†
                    if (opt.val === 'other') {
                        const placeholder = currentLang === 'en' ? 'Please specify time...' : 'è«‹è¨»æ˜å…·é«”æ™‚é–“...';
                        l.innerHTML += `<input type="text" id="other_input_${q.id}" name="${q.id}_detail" class="other-input" placeholder="${placeholder}" onclick="event.stopPropagation()">`;
                    }

                    group.appendChild(l);
                });
                wrapper.appendChild(group);
            }
            else if (q.type === 'matrix') {
                // ... (çŸ©é™£é¡Œä»£ç¢¼ä¿æŒä¸è®Š) ...
                const table = document.createElement('table');
                table.className = 'matrix-table';
                const thead = document.createElement('tr');
                thead.innerHTML = `<th>${currentLang === 'en' ? 'Factor' : 'è¦ç´ '}</th>${q.cols.map(c => `<th>${c}</th>`).join('')}`;
                table.appendChild(thead);
                q.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    let tds = `<td>${row.text[currentLang]}</td>`;
                    q.cols.forEach(colVal => {
                        tds += `<td><input type="radio" name="${q.id}_${row.id}" value="${colVal}"></td>`;
                    });
                    tr.innerHTML = tds;
                    table.appendChild(tr);
                });
                wrapper.appendChild(table);
            }

            container.appendChild(wrapper);
        });
    }

    // ä¿®æ”¹ 4 é…å¥—: è™•ç†é¡¯ç¤º/éš±è—è¼¸å…¥æ¡†çš„å‡½æ•¸ (è«‹æ–°å¢æ­¤å‡½æ•¸åˆ° script ä¸­)
    window.handleOptionChange = (input, qId, val) => {
        const otherInput = document.getElementById(`other_input_${qId}`);
        if (!otherInput) return;

        // å¦‚æœé¸ä¸­äº† 'other'ï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†ï¼›å¦å‰‡éš±è—
        // å°æ–¼ Radio (å–®é¸)ï¼Œåªæœ‰é¸ä¸­ other æ‰é¡¯ç¤º
        // å°æ–¼ Checkbox (å¤šé¸)ï¼Œåªè¦ other è¢«å‹¾é¸å°±é¡¯ç¤º

        if (input.type === 'radio') {
            if (val === 'other' && input.checked) {
                otherInput.style.display = 'block';
                otherInput.focus();
            } else {
                otherInput.style.display = 'none';
                otherInput.value = ''; // æ¸…ç©º
            }
        } else if (input.type === 'checkbox') {
            if (val === 'other') {
                otherInput.style.display = input.checked ? 'block' : 'none';
                if(input.checked) otherInput.focus();
            }
        }
    };

    // è¯­è¨€åˆ‡æ¢é€»è¾‘
    window.setLang = (lang) => {
        currentLang = lang;
        renderForm();

        const texts = {
            'en': {
                welcome: "Welcome to Survey",
                title: "Survey on Victoria Harbour Promenade",
                intro: "This study aims to understand user behavior and experience.",
                map: "Part 3: Activity Trajectory (Draw on Map)",
                mapHint: "1. Click 'Start Drawing' to trace your route.<br>2. After drawing, click on the path to mark stops (multiple stops allowed).",
                draw: "Start Drawing",
                clear: "Redraw",
                submit: "Submit Survey",
                modalTitle: "Please select stay duration:"
            },
            'zh-tw': {
                welcome: "æ­¡è¿åƒåŠ èª¿æŸ¥",
                title: "ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥",
                intro: "ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚",
                map: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)",
                mapHint: "1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>2. ç•«å®Œå¾Œï¼Œé»æ“Šè·¯å¾‘ä¸Šçš„é»æ¨™è¨˜<b>å¤šå€‹åœç•™é»</b>ã€‚",
                draw: "é–‹å§‹ç¹ªè£½è·¯ç·š",
                clear: "æ¸…é™¤é‡ç•«",
                submit: "æäº¤å•å·",
                modalTitle: "è«‹é¸æ“‡åœç•™æ™‚é–“ï¼š"
            },
            'zh-cn': {
                welcome: "æ¬¢è¿å‚åŠ è°ƒæŸ¥",
                title: "ç»´å¤šåˆ©äºšæ¸¯æµ·æ»¨é•¿å»Šä½¿ç”¨ä½“éªŒè°ƒæŸ¥",
                intro: "ç ”ç©¶è¯´æ˜ï¼šæœ¬é—®å·æ—¨åœ¨æ¢è®¨æµ·æ»¨æ­¥é“çš„ä½¿ç”¨è¡Œä¸ºä¸ä½“éªŒã€‚æ‰€æœ‰èµ„æ–™ç»å¯¹ä¿å¯†ã€‚",
                map: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ (è¯·åœ¨åœ°å›¾ä¸Šç»˜åˆ¶)",
                mapHint: "1. ç‚¹å‡»â€œå¼€å§‹ç»˜åˆ¶â€ç”»å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯çº¿</b>ã€‚<br>2. ç”»å®Œåï¼Œç‚¹å‡»è·¯å¾„ä¸Šçš„ç‚¹æ ‡è®°<b>å¤šä¸ªåœç•™ç‚¹</b>ã€‚",
                draw: "å¼€å§‹ç»˜åˆ¶è·¯çº¿",
                clear: "æ¸…é™¤é‡ç”»",
                submit: "æäº¤é—®å·",
                modalTitle: "è¯·é€‰æ‹©åœç•™æ—¶é—´ï¼š"
            }
        };

        // æ›´æ–°æ¬¢è¿æ¨ªå¹…
        const banner = document.getElementById('welcome-banner');
        if(banner) banner.innerText = "ğŸ“¢ " + texts[lang].welcome;

        document.getElementById('txt-title').innerText = texts[lang].title;
        document.getElementById('txt-intro').innerText = texts[lang].intro;
        document.getElementById('lbl-map-task').innerText = texts[lang].map;
        document.getElementById('txt-map-hint').innerHTML = texts[lang].mapHint;
        document.getElementById('txt-draw').innerText = texts[lang].draw;
        document.getElementById('txt-clear').innerText = texts[lang].clear;
        document.getElementById('txt-submit').innerText = texts[lang].submit;
        document.getElementById('modal-title-text').innerText = texts[lang].modalTitle;

        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="setLang('${lang}')"]`).classList.add('active');

        // åˆ‡æ¢åœ°å›¾åº•å›¾è¯­è¨€
        updateMapLanguage(lang);
        // åˆ‡æ¢æ ‡è®°ç‚¹è¯­è¨€ (æ–°å¢)
        if(typeof updateMarkersLanguage === 'function') updateMarkersLanguage(lang);
    };

    // ğŸŸ¢ æ–°å¢ï¼šæ›´æ–°åœ°å›¾è¯­è¨€å‡½æ•°
    function updateMapLanguage(langCode) {
        if (!map || !map.getStyle()) return;

        const style = map.getStyle();
        if (!style.layers) return;

        // Mapbox Streets é»˜è®¤åŒ…å« name_en, name_zh-Hant, name_zh-Hans å­—æ®µ
        // æˆ‘ä»¬éå†æ‰€æœ‰æ–‡å­—å±‚ï¼Œå¼ºåˆ¶æ›´æ”¹ text-field å±æ€§
        const labelLayers = style.layers.filter(layer =>
            layer.type === 'symbol' && layer.layout && layer.layout['text-field']
        );

        let textFieldValue = ['get', 'name']; // é»˜è®¤æœ¬åœ°è¯­è¨€

        if (langCode === 'en') {
            textFieldValue = ['coalesce', ['get', 'name_en'], ['get', 'name']];
        } else if (langCode === 'zh-tw') {
            textFieldValue = ['coalesce', ['get', 'name_zh-Hant'], ['get', 'name']];
        } else if (langCode === 'zh-cn') {
            textFieldValue = ['coalesce', ['get', 'name_zh-Hans'], ['get', 'name']];
        }

        labelLayers.forEach(layer => {
            // åªä¿®æ”¹åŒ…å« 'name' å­—æ®µçš„å›¾å±‚ï¼Œé¿å…ä¿®æ”¹å›¾æ ‡æˆ–å…¶ä»–çº¯æ ¼å¼å›¾å±‚
            try {
                // åˆ¤æ–­å½“å‰å›¾å±‚çš„ text-field æ˜¯å¦ä¾èµ–äº name
                const currentField = JSON.stringify(layer.layout['text-field']);
                if (currentField.includes('name')) {
                     map.setLayoutProperty(layer.id, 'text-field', textFieldValue);
                }
            } catch(e) { console.log(e); }
        });
    }

    // ==========================================
    // ğŸ“ åœ°å›¾æ ‡è®° (POI) æ•°æ®ä¸é€»è¾‘
    // ==========================================

    const poiData = [
        // --- å …å°¼åœ°åŸ & è¥¿ç’° ---
        {
            type: 'leisure',
            coords: [114.1289, 22.2850],
            en: 'Belcher Bay Promenade', zh_tw: 'å‘è·¯ä¹ç£æµ·æ¿±é•·å»Š', zh_cn: 'å‘è·¯ä¹æ¹¾æµ·æ»¨é•¿å»Š',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Belcher_Bay_Promenade_Phase_2_202010.jpg/320px-Belcher_Bay_Promenade_Phase_2_202010.jpg',
            desc: { zh_tw: 'å…¨å¤©å€™é–‹æ”¾çš„ä¼‘é–’ç©ºé–“ï¼Œè¨­æœ‰å¯µç‰©è§’ã€‚', en: 'All-weather leisure space with pet corner.' }
        },

        // --- ä¸Šç’° ---
        {
            type: 'leisure',
            coords: [114.1455, 22.2898],
            en: 'Sun Yat Sen Mem. Park', zh_tw: 'ä¸­å±±ç´€å¿µå…¬åœ’', zh_cn: 'ä¸­å±±çºªå¿µå…¬å›­',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Sun_Yat_Sen_Memorial_Park_Lawn_202005.jpg/320px-Sun_Yat_Sen_Memorial_Park_Lawn_202005.jpg',
            desc: { zh_tw: 'æ“æœ‰å¤§ç‰‡åœ“å½¢è‰åªï¼Œé©åˆé‡é¤èˆ‡é‹å‹•ã€‚', en: 'Large circular lawn perfect for picnics.' }
        },
        {
            type: 'transport',
            coords: [114.1518, 22.2881],
            en: 'HK-Macau Ferry Terminal', zh_tw: 'æ¸¯æ¾³ç¢¼é ­', zh_cn: 'æ¸¯æ¾³ç å¤´',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Shun_Tak_Centre_2018.jpg/320px-Shun_Tak_Centre_2018.jpg',
            desc: { zh_tw: 'é€£æ¥é¦™æ¸¯èˆ‡æ¾³é–€çš„é‡è¦äº¤é€šæ¨ç´ã€‚', en: 'Key transport hub connecting HK and Macau.' }
        },

        // --- ä¸­ç’° ---
        {
            type: 'transport',
            coords: [114.1614, 22.2868],
            en: 'Central Ferry Piers', zh_tw: 'ä¸­ç’°ç¢¼é ­', zh_cn: 'ä¸­ç¯ç å¤´',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f6/Central_Piers_Overview_2017.jpg/320px-Central_Piers_Overview_2017.jpg',
            desc: { zh_tw: 'å¾€è¿”é›¢å³¶çš„ä¸»è¦æ¸¡è¼ªç¢¼é ­ã€‚', en: 'Main ferry piers for outlying islands.' }
        },
        {
            type: 'leisure',
            coords: [114.1617, 22.2853],
            en: 'HK Observation Wheel', zh_tw: 'é¦™æ¸¯æ‘©å¤©è¼ª', zh_cn: 'é¦™æ¸¯æ‘©å¤©è½®',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Hong_Kong_Observation_Wheel_201505.jpg/320px-Hong_Kong_Observation_Wheel_201505.jpg',
            desc: { zh_tw: 'æ¨™èªŒæ€§åœ°æ¨™ï¼Œé£½è¦½ç¶­æ¸¯æ—¥å¤œç¾æ™¯ã€‚', en: 'Iconic landmark offering harbor views.' }
        },
        {
            type: 'leisure',
            coords: [114.1656, 22.2816],
            en: 'Tamar Park', zh_tw: 'æ·»é¦¬å…¬åœ’', zh_cn: 'æ·»é©¬å…¬å›­',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/Tamar_Park_Green_Lawn_2012.jpg/320px-Tamar_Park_Green_Lawn_2012.jpg',
            desc: { zh_tw: 'é€£æ¥æ”¿åºœç¸½éƒ¨çš„ç¶ åŒ–ç©ºé–“ï¼Œã€Œç¶ åœ°æ¯¯ã€è‰åªã€‚', en: 'Green space connecting Gov HQ.' }
        },

        // --- é‡‘é˜ ---
        {
            type: 'transport',
            coords: [114.1646, 22.2794],
            en: 'MTR Admiralty Station', zh_tw: 'æ¸¯éµé‡‘é˜ç«™', zh_cn: 'æ¸¯é“é‡‘é’Ÿç«™',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/43/Admiralty_Station_Exit_A_2019.jpg/320px-Admiralty_Station_Exit_A_2019.jpg',
            desc: { zh_tw: 'ä¸»è¦æ›ä¹˜å¤§ç«™ã€‚', en: 'Major interchange station.' }
        },

        // --- ç£ä»” ---
        {
            type: 'leisure',
            coords: [114.1739, 22.2844],
            en: 'Golden Bauhinia Sq.', zh_tw: 'é‡‘ç´«èŠå»£å ´', zh_cn: 'é‡‘ç´«è†å¹¿åœº',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Golden_Bauhinia_Square_2014.jpg/320px-Golden_Bauhinia_Square_2014.jpg',
            desc: { zh_tw: 'å›æ­¸ç´€å¿µåœ°æ¨™ï¼ŒéŠå®¢å¿…åˆ°ä¹‹è™•ã€‚', en: 'Historic landmark for the handover.' }
        },
        {
            type: 'transport',
            coords: [114.1747, 22.2817],
            en: 'MTR Exhibition Centre Stn.', zh_tw: 'æ¸¯éµæœƒå±•ç«™', zh_cn: 'æ¸¯é“ä¼šå±•ç«™',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/62/Exhibition_Centre_Station_Exit_B3_202205.jpg/320px-Exhibition_Centre_Station_Exit_B3_202205.jpg',
            desc: { zh_tw: 'ç›´é”ç£ä»”æµ·æ¿±çš„æœ€æ–°éµè·¯ç«™ã€‚', en: 'Direct access to Wan Chai promenade.' }
        },
        {
            type: 'transport',
            coords: [114.1762, 22.2835],
            en: 'Wan Chai Ferry Pier', zh_tw: 'ç£ä»”æ¸¡è¼ªç¢¼é ­', zh_cn: 'æ¹¾ä»”æ¸¡è½®ç å¤´',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Wan_Chai_Ferry_Pier_2015.jpg/320px-Wan_Chai_Ferry_Pier_2015.jpg',
            desc: { zh_tw: 'å¾€è¿”å°–æ²™å’€çš„ç¶“å…¸èˆªç·šã€‚', en: 'Classic ferry route to TST.' }
        },
        {
            type: 'leisure',
            coords: [114.1767, 22.2826],
            en: 'HarbourChill', zh_tw: 'HarbourChill æµ·æ¿±ä¼‘é–’ç«™', zh_cn: 'HarbourChill æµ·æ»¨ä¼‘é—²ç«™',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/HarbourChill_Seating_2021.jpg/320px-HarbourChill_Seating_2021.jpg',
            desc: { zh_tw: 'å……æ»¿ç‰¹è‰²çš„ä¼‘æ†©è¨­æ–½ï¼Œé©åˆæ‰“å¡ã€‚', en: 'Chill spot with unique seating.' }
        },
        {
            type: 'leisure',
            coords: [114.1802, 22.2825],
            en: 'Water Sports Precinct', zh_tw: 'æ°´ä¸Šé‹å‹•åŠåº·æ¨‚ä¸»é¡Œå€', zh_cn: 'æ°´ä¸Šè¿åŠ¨åŠåº·ä¹ä¸»é¢˜åŒº',
            img: 'https://www.devb.gov.hk/filemanager/en/content_1246/Water_Sports_and_Recreation_Precinct_Phase_2_1.jpg', // ä½¿ç”¨å®˜æ–¹æˆ–é€šç”¨åœ–ç‰‡
            desc: { zh_tw: 'æä¾›æ°´ä¸Šå–®è»Šé«”é©—èˆ‡é¤é£²è¨­æ–½ã€‚', en: 'Water bikes and dining facilities.' }
        },

        // --- éŠ…é‘¼ç£ ---
        {
            type: 'leisure',
            coords: [114.1858, 22.2840],
            en: 'Typhoon Shelter Precinct', zh_tw: 'éŠ…é‘¼ç£é¿é¢¨å¡˜æµ·æ¿±', zh_cn: 'é“œé”£æ¹¾é¿é£å¡˜æµ·æ»¨',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Causeway_Bay_Typhoon_Shelter_Sunset_2016.jpg/320px-Causeway_Bay_Typhoon_Shelter_Sunset_2016.jpg',
            desc: { zh_tw: 'æ¬£è³å‚³çµ±èˆ¢èˆ¨èˆ‡æ—¥è½çš„æœ€ä½³åœ°é»ã€‚', en: 'Best spot for sampans and sunset.' }
        },
        {
            type: 'transport',
            coords: [114.1835, 22.2800],
            en: 'MTR Causeway Bay', zh_tw: 'éŠ…é‘¼ç£ç«™', zh_cn: 'é“œé”£æ¹¾ç«™',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/36/Causeway_Bay_Station_Exit_E_2017.jpg/320px-Causeway_Bay_Station_Exit_E_2017.jpg',
            desc: { zh_tw: 'é„°è¿‘ç¶­åœ’èˆ‡è³¼ç‰©å€ã€‚', en: 'Near Victoria Park and shopping.' }
        },

        // --- ç‚®å°å±± ---
        {
            type: 'leisure',
            coords: [114.1915, 22.2885],
            en: 'East Coast Park Precinct', zh_tw: 'æ±å²¸å…¬åœ’ä¸»é¡Œå€', zh_cn: 'ä¸œå²¸å…¬å›­ä¸»é¢˜åŒº',
            img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/East_Coast_Park_Precinct_Breakwater_202109.jpg/320px-East_Coast_Park_Precinct_Breakwater_202109.jpg',
            desc: { zh_tw: 'æ“æœ‰ç¬¬ä¸€æ¢å‘å…¬çœ¾é–‹æ”¾çš„é˜²æ³¢å ¤ã€‚', en: 'First public breakwater in Victoria Harbour.' }
        }
    ];

    let currentMarkers = [];

    function renderMarkers(mapInstance) {
        currentMarkers.forEach(m => m.remove());
        currentMarkers = [];

        poiData.forEach(poi => {
            const el = document.createElement('div');
            // ä½¿ç”¨æ–°çš„ CSS é¡å marker-pinï¼Œä¸¦åŠ ä¸Šé¡è‰²å€åˆ†
            el.className = `marker-pin ${poi.type === 'transport' ? 'marker-transport' : 'marker-leisure'}`;

            // æ•¸æ“šç¶å®š
            el.dataset.en = poi.en;
            el.dataset.zh_tw = poi.zh_tw;
            el.dataset.zh_cn = poi.zh_cn;

            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(getPopupContent(poi, currentLang));

            // ä¿®æ”¹ 1: é—œéµä¿®æ­£ï¼å› ç‚ºæ”¹ç”¨äº†æ°´æ»´é‡å‹ï¼Œé‡å°–åœ¨åº•éƒ¨ï¼Œæ‰€ä»¥ anchor å¿…é ˆè¨­ç‚º 'bottom'
            const marker = new mapboxgl.Marker({ element: el, anchor: 'bottom' })
                .setLngLat(poi.coords)
                .setPopup(popup)
                .addTo(mapInstance);

            currentMarkers.push({ marker: marker, data: poi, popup: popup });
        });
    }

    function getPopupContent(poi, lang) {
        const name = lang === 'en' ? poi.en : (lang === 'zh-tw' ? poi.zh_tw : poi.zh_cn);
        // ä½¿ç”¨æ•¸æ“šä¸­çš„æè¿°ï¼Œå¦‚æœæ²’æœ‰å‰‡é¡¯ç¤ºé»˜èªæ–‡å­—
        const defaultDesc = lang === 'en' ? 'Click map nearby to add stop.' : 'é»æ“Šé™„è¿‘åœ°åœ–å¯æ·»åŠ åœç•™é»ã€‚';
        const description = poi.desc ? (lang === 'en' ? poi.desc.en : poi.desc.zh_tw) : defaultDesc;

        let typeLabel = "";
        let bgColor = "";

        // è¨­ç½®æ¨™ç±¤æ–‡å­—èˆ‡é¡è‰²
        if (poi.type === 'transport') {
            typeLabel = lang === 'en' ? "Transport" : "äº¤é€šæ¨ç´";
            bgColor = "#0d6efd"; // è—è‰²
        } else {
            typeLabel = lang === 'en' ? "Leisure & Photo" : "ä¼‘é–’ / æ‰“å¡";
            bgColor = "#fd7e14"; // æ©™è‰²
        }

        // ä½¿ç”¨æ•¸æ“šä¸­çš„åœ–ç‰‡ï¼Œå¦‚æœåœ–ç‰‡åŠ è¼‰å¤±æ•—æˆ–æ²’æœ‰åœ–ç‰‡ï¼Œå¯ä»¥ç”¨ä¸€å€‹é€šç”¨çš„ä½”ä½åœ–
        // é€™è£¡ä½¿ç”¨ onerror ä¾†è™•ç†åœ–ç‰‡åŠ è¼‰å¤±æ•—çš„æƒ…æ³ï¼Œé¡¯ç¤ºç°è‰²èƒŒæ™¯
        const imgSrc = poi.img || 'https://via.placeholder.com/300x150?text=No+Image';

        // è¿”å›å¡ç‰‡ HTML çµæ§‹
        return `
            <div class="poi-card">
                <img src="${imgSrc}" class="poi-image" alt="${name}" onerror="this.style.backgroundColor='#ddd';this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEyIDJDNi40OCAyIDIgNi40OCAyIDEyczQuNDggMTAgMTAgMTAgMTAtNC40OCAxMC0xMFMxNy41MiAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDggLTggOHoiLz48L3N2Zz4='">
                <div class="poi-info">
                    <div class="poi-title">${name}</div>
                    <span class="poi-tag" style="background-color: ${bgColor};">${typeLabel}</span>
                    <div class="poi-desc">${description}</div>
                </div>
            </div>
        `;
    }

    function updateMarkersLanguage(lang) {
        if (!currentMarkers) return;
        currentMarkers.forEach(item => {
            item.popup.setHTML(getPopupContent(item.data, lang));
        });
    }

    // ==========================================
    // ğŸ—ºï¸ åœ°å›¾é€»è¾‘ (Mapbox)
    // ==========================================
    mapboxgl.accessToken = 'pk.eyJ1Ijoiamh3MTExIiwiYSI6ImNtazgybjFyeDFidGczY29laWRtemFkMnoifQ.y1ffbT2LMx4jc8ZT8u9xXg';

    let map;
    let userStopMarkers = [];
    let isDrawing = false, drawMode = false, pathCoordinates = [], stopsData = [];
    const statusBar = document.getElementById('status-bar');

<!--    async function initApp() {-->
<!--        renderForm(); // åˆå§‹åŒ–è¡¨å•-->

<!--        let config = null;-->
<!--        if (window.fetchSurveyConfig) {-->
<!--            config = await window.fetchSurveyConfig();-->
<!--        }-->

<!--        if (config) {-->
<!--            console.log("Configuration loaded:", config);-->

<!--            // -&#45;&#45; æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²å¡«å†™ -&#45;&#45;-->
<!--            if (config.enabledDailyLimit) {-->
<!--                const todayStr = new Date().toISOString().split('T')[0];-->
<!--                const lastSubmitDate = localStorage.getItem('survey_last_submit_date');-->

<!--                if (lastSubmitDate === todayStr) {-->
<!--                    document.getElementById('submitted-mask').style.display = 'flex';-->
<!--                    document.body.style.overflow = 'hidden';-->
<!--                    return;-->
<!--                }-->
<!--            }-->

<!--            // æ£€æŸ¥é—®å·æ˜¯å¦å¼€æ”¾-->
<!--            if (config.isSurveyOpen === false) {-->
<!--                document.getElementById('closed-mask').style.display = 'flex';-->
<!--                document.body.style.overflow = 'hidden';-->
<!--                return;-->
<!--            }-->

<!--            // æ˜¾ç¤ºå…¬å‘Š-->
<!--            if (config.announcement) {-->
<!--                const banner = document.getElementById('announcement-bar');-->
<!--                banner.innerText = "ğŸ“¢ " + config.announcement;-->
<!--                banner.style.display = 'block';-->
<!--            }-->
<!--        }-->

<!--        // ç¡®å®šåœ°å›¾æ ·å¼-->
<!--        let mapStyleUrl = 'mapbox://styles/mapbox/streets-v11';-->
<!--        if (config && config.mapStyle) {-->
<!--            if (config.mapStyle === 'light') {-->
<!--                mapStyleUrl = 'mapbox://styles/mapbox/light-v10';-->
<!--            } else if (config.mapStyle.startsWith('mapbox://')) {-->
<!--                mapStyleUrl = config.mapStyle;-->
<!--            }-->
<!--        }-->

<!--        map = new mapboxgl.Map({-->
<!--            container: 'map',-->
<!--            style: mapStyleUrl,-->
<!--            center: [114.16, 22.285],-->
<!--            zoom: 13,-->
<!--            pitch: 0,-->
<!--        });-->

<!--        map.on('load', () => {-->
<!--            map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });-->
<!--            map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#e74c3c', 'line-width': 5, 'line-opacity': 0.8 } });-->
<!--            statusBar.innerText = "Ready";-->

<!--            // åˆå§‹åŒ–æ—¶è®¾ç½®åœ°å›¾è¯­è¨€-->
<!--            updateMapLanguage(currentLang);-->

<!--            setupMapInteractions();-->
<!--        });-->
<!--    }-->

    // ==========================================
    // ğŸ› ï¸ ä¿®æ”¹ä½ç½® 2ï¼šé¡µé¢åŠ è½½æ—¶çš„å¼ºåŠ›æ£€æŸ¥
    // ==========================================

    // 1. ç«‹å³æ‰§è¡Œæ£€æŸ¥ (IIFE) - æ”¾åœ¨è„šæœ¬æœ€å‰é¢
<!--    (function() {-->
<!--        const lastSubmitDate = localStorage.getItem('survey_last_submit_date');-->
<!--        const todayStr = getLocalTodayDate(); // ä½¿ç”¨ç»Ÿä¸€å‡½æ•°-->

<!--        if (lastSubmitDate === todayStr) {-->
<!--            // å¦‚æœæœ¬åœ°å­˜çš„æ—¥æœŸä¹Ÿæ˜¯ä»Šå¤©ï¼Œå¼ºåˆ¶æ˜¾ç¤ºå·²æäº¤é®ç½©-->
<!--            // ç­‰å¾… DOM è§£æå®Œæˆåç«‹å³æ‰§è¡Œ-->
<!--            window.addEventListener('DOMContentLoaded', () => {-->
<!--                const mask = document.getElementById('submitted-mask');-->
<!--                const sidebar = document.getElementById('sidebar');-->
<!--                const mapDiv = document.getElementById('map');-->

<!--                if (mask) mask.style.display = 'flex';-->
<!--                if (sidebar) sidebar.style.display = 'none'; // å½»åº•éšè—ä¾§è¾¹æ -->
<!--                if (mapDiv) mapDiv.style.display = 'none';   // å½»åº•éšè—åœ°å›¾-->
<!--                document.body.style.overflow = 'hidden';     // ç¦æ­¢æ»šåŠ¨-->
<!--            });-->
<!--        }-->
<!--    })();-->

    // 2. ä¿®æ”¹ initApp ä¸­çš„æ£€æŸ¥é€»è¾‘
    async function initApp() {
        // --- æ–°å¢ï¼šå†æ¬¡æ£€æŸ¥æœ¬åœ°ç¼“å­˜ ---
        const lastSubmitDate = localStorage.getItem('survey_last_submit_date');
        const todayStr = getLocalTodayDate();

        if (lastSubmitDate === todayStr) {
            console.log("ä»Šæ—¥å·²æäº¤ï¼Œåœæ­¢åˆå§‹åŒ–ã€‚");
            document.getElementById('submitted-mask').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
            return; // â›”ï¸ ç›´æ¥ç»ˆæ­¢åç»­ä»£ç ï¼ˆä¸åŠ è½½é…ç½®ï¼Œä¸åŠ è½½åœ°å›¾ï¼‰
        }
        // ---------------------------

        renderForm(); // åˆå§‹åŒ–è¡¨å•

        // ç­‰å¾… Firebase module åŠ è½½å®Œæ¯•
        let config = null;
        if (window.fetchSurveyConfig) {
            config = await window.fetchSurveyConfig();
        }

        // 3.1 å¤„ç†é…ç½®é€»è¾‘
        if (config) {
            console.log("Configuration loaded:", config);

            // --- âœ¨ æ¯æ—¥é™åˆ¶æ£€æŸ¥é€»è¾‘ (ä¿®å¤æ—¶åŒºç‰ˆ) ---
            // ç¡®ä¿å¼€å…³å¼€å¯
            const isLimitEnabled = config.enabledDailyLimit === true || config.enabledDailyLimit === "true";

            if (isLimitEnabled) {
                // è·å–æœ¬åœ°æ—¶é—´ (è§£å†³ UTC æ—¶å·®é—®é¢˜)
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`; // æ ¼å¼ï¼š2026-01-16

                const lastSubmitDate = localStorage.getItem('survey_last_submit_date');

                console.log(`Limit Check: Today=${todayStr}, Last=${lastSubmitDate}`);

                if (lastSubmitDate === todayStr) {
                    // å¦‚æœè®°å½•çš„æ—¥æœŸæ˜¯ä»Šå¤©ï¼Œæ˜¾ç¤ºæ„Ÿè°¢å±‚
                    document.getElementById('submitted-mask').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    return; // â›”ï¸ åœæ­¢åŠ è½½
                }
            }
            // ------------------------------------

            // æ£€æŸ¥é—®å·æ˜¯å¦å¼€æ”¾
            if (config.isSurveyOpen === false) {
                document.getElementById('closed-mask').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                return;
            }

            // æ˜¾ç¤ºå…¬å‘Š
            if (config.announcement) {
                const banner = document.getElementById('announcement-bar');
                banner.innerText = "ğŸ“¢ " + config.announcement;
                banner.style.display = 'block';
            }
        }

<!--        renderForm(); // åˆå§‹åŒ–è¡¨å•-->

<!--        // 1. å…ˆç­‰å¾…é…ç½®åŠ è½½-->
<!--        let config = null;-->
<!--        try {-->
<!--            if (window.fetchSurveyConfig) {-->
<!--                config = await window.fetchSurveyConfig();-->
<!--            }-->
<!--        } catch (e) {-->
<!--            console.error("âŒ Firebase é…ç½®åŠ è½½å¤±è´¥:", e);-->
<!--        }-->

<!--        // 2. æ ¸å¿ƒæ£€æŸ¥é€»è¾‘-->
<!--        if (config) {-->
<!--            console.log("âœ… é…ç½®å·²åŠ è½½:", config);-->

<!--            // è·å–ä»Šæ—¥æ—¥æœŸ-->
<!--            const todayStr = getLocalTodayDate();-->

<!--            // ä»æœ¬åœ°è¯»å–è®°å½•-->
<!--            const lastDate = localStorage.getItem('survey_last_submit_date');-->
<!--            let dailyCount = parseInt(localStorage.getItem('survey_daily_count') || '0');-->

<!--            console.log(`ğŸ” çŠ¶æ€æ£€æŸ¥: ä¸Šæ¬¡æ—¥æœŸ=${lastDate}, ä»Šæ—¥=${todayStr}, å½“å‰è®¡æ•°=${dailyCount}`);-->

<!--            // å¦‚æœæ—¥æœŸè·¨å¤©äº†ï¼ˆæˆ–è€…ä¸Šæ¬¡æ—¥æœŸæ˜¯nullï¼‰ï¼Œé‡ç½®è®¡æ•°å™¨-->
<!--            if (lastDate !== todayStr) {-->
<!--                console.log("ğŸ“… æ—¥æœŸå˜æ›´ï¼Œé‡ç½®è®¡æ•°å™¨ä¸º 0");-->
<!--                dailyCount = 0;-->
<!--                localStorage.setItem('survey_daily_count', '0');-->
<!--                // æ³¨æ„ï¼šè¿™é‡Œä¸æ¸…é™¤ last_submit_dateï¼Œåªé‡ç½®è®¡æ•°-->
<!--            }-->

<!--            // -&#45;&#45; æ¯å¤© N æ¬¡é™åˆ¶é€»è¾‘ -&#45;&#45;-->
<!--            // ğŸ”§ ä¿®æ”¹ï¼šæ”¾å®½åˆ¤æ–­ï¼Œå…¼å®¹å­—ç¬¦ä¸² "true" å’Œå¸ƒå°”å€¼ true-->
<!--            const isLimitEnabled = String(config.enabledDailyLimit) === 'true';-->

<!--            // è·å–åå°è®¾ç½®çš„æ¬¡æ•°ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œé»˜è®¤ä¸º 1 æ¬¡-->
<!--            const maxLimit = (typeof config.maxDailySubmissions === 'number') ? config.maxDailySubmissions : 1;-->

<!--            if (isLimitEnabled) {-->
<!--                console.log(`ğŸ›¡ï¸ é™åˆ¶æ£€æŸ¥: Count(${dailyCount}) >= Max(${maxLimit}) ? ${dailyCount >= maxLimit}`);-->

<!--                // å¦‚æœå½“å‰æ¬¡æ•°å·²ç»è¾¾åˆ°æˆ–è¶…è¿‡é™åˆ¶ -> å°é”-->
<!--                if (dailyCount >= maxLimit) {-->
<!--                    document.getElementById('submitted-mask').style.display = 'flex';-->

<!--                    // æ›´æ–°é®ç½©ä¸Šçš„æ–‡æ¡ˆ-->
<!--                    const maskTitle = document.querySelector('#submitted-mask h2:nth-of-type(2)');-->
<!--                    const maskDesc = document.querySelector('#submitted-mask p');-->
<!--                    if(maskTitle) maskTitle.innerText = "Quota Exceeded / æ¬¡æ•¸å·²é”ä¸Šé™";-->
<!--                    if(maskDesc) maskDesc.innerHTML = `You have reached the daily limit (${maxLimit} times).<br>æ‚¨ä»Šæ—¥çš„å¡«å¯«æ¬¡æ•¸å·²é”ä¸Šé™ï¼ˆ${maxLimit}æ¬¡ï¼‰ã€‚`;-->

<!--                    document.getElementById('sidebar').style.display = 'none';-->
<!--                    return; // â›”ï¸ åœæ­¢åŠ è½½-->
<!--                }-->
<!--            }-->

<!--            // æ£€æŸ¥é—®å·æ˜¯å¦å¼€æ”¾-->
<!--            // ğŸ”§ ä¿®æ”¹ï¼šåŒæ ·æ”¾å®½åˆ¤æ–­-->
<!--            if (String(config.isSurveyOpen) === 'false') {-->
<!--                document.getElementById('closed-mask').style.display = 'flex';-->
<!--                document.body.style.overflow = 'hidden';-->
<!--                return;-->
<!--            }-->

<!--            // æ˜¾ç¤ºå…¬å‘Š-->
<!--            if (config.announcement) {-->
<!--                const banner = document.getElementById('announcement-bar');-->
<!--                banner.innerText = "ğŸ“¢ " + config.announcement;-->
<!--                banner.style.display = 'block';-->
<!--            }-->
<!--        } else {-->
<!--            console.warn("âš ï¸ æœªè¯»å–åˆ° Firebase é…ç½®ï¼Œè·³è¿‡é™åˆ¶æ£€æŸ¥ã€‚");-->
<!--        }-->

        // 3.2 ç¡®å®šåœ°å›¾æ ·å¼
        let mapStyleUrl = 'mapbox://styles/mapbox/streets-v11';
        if (config && config.mapStyle) {
            if (config.mapStyle === 'light') {
                mapStyleUrl = 'mapbox://styles/mapbox/light-v10';
            } else if (config.mapStyle.startsWith('mapbox://')) {
                mapStyleUrl = config.mapStyle;
            }
        }

        // 3.3 åˆå§‹åŒ–åœ°å›¾
<!--        map = new mapboxgl.Map({-->
<!--            container: 'map',-->
<!--            style: mapStyleUrl,-->
<!--            center: [114.16, 22.285],-->
<!--            zoom: 13,-->
<!--            pitch: 0,-->
<!--        });-->
        map = new mapboxgl.Map({
            container: 'map',
            style: mapStyleUrl,
            // ä¿®æ”¹ï¼šæ”¾å¤§åœ°åœ–ï¼Œè®“ç”¨æˆ¶æ›´æ¸…æ¥šçœ‹åˆ°ç´°ç¯€
            center: [114.155, 22.288],
            zoom: 14.5, // é»˜èªç¸®æ”¾ç´šåˆ¥åŠ å¤§
            pitch: 0,
            // æ–°å¢ï¼šé™åˆ¶åœ°åœ–æ‹–å‹•ç¯„åœ (å—è‡³å±±é ‚ï¼ŒåŒ—è‡³ä¹é¾ï¼Œè¥¿è‡³å …å°¼åœ°åŸï¼Œæ±è‡³åŒ—è§’)
            maxBounds: [
                [114.10, 22.26], // è¥¿å—è§’
                [114.22, 22.31]  // æ±åŒ—è§’
            ]
        });

        map.on('load', () => {
            map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
            map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#e74c3c', 'line-width': 5, 'line-opacity': 0.8 } });

            // --- ä¿®æ”¹ 2: é«˜ç²¾åº¦ç¶­æ¸¯å€åŸŸé«˜äº® (è²¼åˆåº¦ > 85%) ---
            const harbourAreaGeoJSON = {
                'type': 'Feature',
                'geometry': {
                    'type': 'Polygon',
                    "coordinates": [[
            [
              114.12753730856457,
              22.283984871963796
            ],
            [
              114.12879187000414,
              22.28444017430685
            ],
            [
              114.13095654926184,
              22.28631224800023
            ],
            [
              114.13250614091174,
              22.28765700868655
            ],
            [
              114.13345357706243,
              22.28780595083991
            ],
            [
              114.13474135101586,
              22.287575119280646
            ],
            [
              114.1360699383905,
              22.287597271665305
            ],
            [
              114.13810382997099,
              22.28822512019761
            ],
            [
              114.13886315215495,
              22.288722165264375
            ],
            [
              114.14022020101464,
              22.289292521618705
            ],
            [
              114.14285840946405,
              22.289300553714114
            ],
            [
              114.14721349221423,
              22.28861324801956
            ],
            [
              114.1498075230869,
              22.288142330639403
            ],
            [
              114.15349229961816,
              22.287151680050357
            ],
            [
              114.15461417092928,
              22.286919190849673
            ],
            [
              114.15520235390522,
              22.286707994108212
            ],
            [
              114.15588822721531,
              22.286324469927038
            ],
            [
              114.15658236101268,
              22.285032207017792
            ],
            [
              114.1577435574128,
              22.283685582228372
            ],
            [
              114.15859600408965,
              22.28300622215015
            ],
            [
              114.16016374978852,
              22.28225518083927
            ],
            [
              114.16221205709269,
              22.281707777641884
            ],
            [
              114.16246958662663,
              22.28234602484072
            ],
            [
              114.16262446588667,
              22.28288833845626
            ],
            [
              114.16492567789743,
              22.282255409851373
            ],
            [
              114.16450085559921,
              22.280808555388163
            ],
            [
              114.1646500329428,
              22.280442038871755
            ],
            [
              114.16608869102237,
              22.279623383006992
            ],
            [
              114.16677857093322,
              22.279712770996127
            ],
            [
              114.16770012048954,
              22.279814281995527
            ],
            [
              114.16807378783102,
              22.279841885367873
            ],
            [
              114.1682451100105,
              22.279903772162555
            ],
            [
              114.16966130863432,
              22.279596749504364
            ],
            [
              114.17049956750782,
              22.27958099223423
            ],
            [
              114.17203499021917,
              22.279344962678863
            ],
            [
              114.17436845461975,
              22.27950826634695
            ],
            [
              114.1755461996753,
              22.279645028861978
            ],
            [
              114.17605844264222,
              22.2797146459002
            ],
            [
              114.17701046021898,
              22.279942763714743
            ],
            [
              114.17877896596588,
              22.280520125716563
            ],
            [
              114.18075190400435,
              22.280838211175094
            ],
            [
              114.18259730612965,
              22.281743423931786
            ],
            [
              114.18597463852615,
              22.282858479292514
            ],
            [
              114.18712332305529,
              22.2800360438151
            ],
            [
              114.18724000398953,
              22.279608024007345
            ],
            [
              114.18768675378504,
              22.279570459929175
            ],
            [
              114.19121770789195,
              22.281912266702406
            ],
            [
              114.19098280667248,
              22.284704222507997
            ],
            [
              114.1906318568602,
              22.28534384260996
            ],
            [
              114.19028391294808,
              22.28588165331054
            ],
            [
              114.18979939402595,
              22.286374396196464
            ],
            [
              114.19084331212628,
              22.28710841553827
            ],
            [
              114.19137136070918,
              22.28682933276113
            ],
            [
              114.19281782423985,
              22.28849423440363
            ],
            [
              114.19405776986702,
              22.289835875018966
            ],
            [
              114.19363719039319,
              22.29015376018343
            ],
            [
              114.19470241433726,
              22.29136219326088
            ],
            [
              114.1963069367057,
              22.292036623383325
            ],
            [
              114.1986885324032,
              22.292577839802732
            ],
            [
              114.19872508283663,
              22.292392935801757
            ],
            [
              114.19990042732331,
              22.292648777527987
            ],
            [
              114.20000756758532,
              22.29261090152781
            ],
            [
              114.20009993444569,
              22.292341479363643
            ],
            [
              114.2028614554307,
              22.2929044647542
            ],
            [
              114.20374503510766,
              22.293104363859854
            ],
            [
              114.20425180903015,
              22.29311165468029
            ],
            [
              114.20489432781108,
              22.292913087660253
            ],
            [
              114.20627492359137,
              22.29260060024066
            ],
            [
              114.20808993821493,
              22.292047521311943
            ],
            [
              114.20895658325571,
              22.291761561102177
            ],
            [
              114.20921639862365,
              22.291497633741884
            ],
            [
              114.20926700469454,
              22.291252250963225
            ],
            [
              114.20898851397453,
              22.29108024979874
            ],
            [
              114.20929179967345,
              22.290590257422224
            ],
            [
              114.20998799599528,
              22.29077209928623
            ],
            [
              114.21097796402682,
              22.288629345586358
            ],
            [
              114.21153171444996,
              22.28857559228088
            ],
            [
              114.21242203338727,
              22.28809540076611
            ],
            [
              114.21393511199551,
              22.287859012098437
            ],
            [
              114.22050478877804,
              22.287917491248237
            ],
            [
              114.22075091360466,
              22.28761132087088
            ],
            [
              114.22097064610756,
              22.28533519091374
            ],
            [
              114.22176485389019,
              22.285424244810983
            ],
            [
              114.22198964304755,
              22.284146228504113
            ],
            [
              114.22352349558412,
              22.28209490427693
            ],
            [
              114.22460271315299,
              22.28160148558881
            ],
            [
              114.22606789286209,
              22.283076523951124
            ],
            [
              114.2248211893932,
              22.284293603137513
            ],
            [
              114.22565328325527,
              22.285027856147636
            ],
            [
              114.22224461185488,
              22.288234083405086
            ],
            [
              114.21965085729079,
              22.28937905440543
            ],
            [
              114.21542488790988,
              22.290087429709374
            ],
            [
              114.2112836049339,
              22.291981380857337
            ],
            [
              114.21026462125997,
              22.292253942517448
            ],
            [
              114.20982969488148,
              22.292100857214876
            ],
            [
              114.20630348555017,
              22.293224738297766
            ],
            [
              114.20342915911567,
              22.293735235701902
            ],
            [
              114.20344236203988,
              22.29457846066613
            ],
            [
              114.2031268693425,
              22.294559823436032
            ],
            [
              114.20320037046042,
              22.294037618284335
            ],
            [
              114.20302579107295,
              22.293906598870876
            ],
            [
              114.20120479376527,
              22.293524820292873
            ],
            [
              114.2008207391192,
              22.294817721050862
            ],
            [
              114.20062686788151,
              22.294775506449014
            ],
            [
              114.20083365884204,
              22.29347119672552
            ],
            [
              114.20009276461406,
              22.293296719025264
            ],
            [
              114.19982171806635,
              22.29448065820388
            ],
            [
              114.1995892601139,
              22.294403258147312
            ],
            [
              114.19989395161093,
              22.29329818448244
            ],
            [
              114.19869068254707,
              22.293057319803395
            ],
            [
              114.19863440911695,
              22.293401357054037
            ],
            [
              114.19831372762565,
              22.293666322138748
            ],
            [
              114.19787909666996,
              22.29380367895186
            ],
            [
              114.19702941840205,
              22.29359429455245
            ],
            [
              114.19649472790661,
              22.293276555170266
            ],
            [
              114.19480733695161,
              22.292898533401043
            ],
            [
              114.19324543350598,
              22.2920691252517
            ],
            [
              114.19103234561294,
              22.290250640667367
            ],
            [
              114.18837351291796,
              22.287573907400272
            ],
            [
              114.18757718803664,
              22.288104468317812
            ],
            [
              114.1874498349606,
              22.28810502070779
            ],
            [
              114.18741972233192,
              22.288002468308065
            ],
            [
              114.18868539884608,
              22.28724165211024
            ],
            [
              114.18922609541892,
              22.2858467256915
            ],
            [
              114.18928514556518,
              22.285312291127326
            ],
            [
              114.18879766094955,
              22.28475537949805
            ],
            [
              114.18660825990275,
              22.284286596531487
            ],
            [
              114.18638155517846,
              22.28432360619766
            ],
            [
              114.18552634800875,
              22.284058981576237
            ],
            [
              114.18492388003148,
              22.283331127047816
            ],
            [
              114.18314574681915,
              22.282320620043166
            ],
            [
              114.18305392578935,
              22.28238289007335
            ],
            [
              114.18299716604957,
              22.282506879682273
            ],
            [
              114.1830548387407,
              22.28291772187272
            ],
            [
              114.18334857291615,
              22.284513260154796
            ],
            [
              114.18336271456798,
              22.285007702210237
            ],
            [
              114.18274909458495,
              22.284867712641926
            ],
            [
              114.18243504995934,
              22.28555075548627
            ],
            [
              114.18239306503688,
              22.28560395215628
            ],
            [
              114.18231182180051,
              22.28558884197507
            ],
            [
              114.18228620747232,
              22.285527765433287
            ],
            [
              114.1825813927988,
              22.28488188936464
            ],
            [
              114.18256102466722,
              22.28481252148329
            ],
            [
              114.1823362713265,
              22.284726525038593
            ],
            [
              114.18209776634342,
              22.284760576469168
            ],
            [
              114.18199007009008,
              22.284632197131955
            ],
            [
              114.18189591407258,
              22.28456114409221
            ],
            [
              114.18188791835632,
              22.28451920877248
            ],
            [
              114.1818397155588,
              22.284487381573683
            ],
            [
              114.18143948065699,
              22.284580011240976
            ],
            [
              114.18143624914876,
              22.28452489307034
            ],
            [
              114.18175685909188,
              22.284396350606514
            ],
            [
              114.18184789407559,
              22.284353488997
            ],
            [
              114.18187647933246,
              22.284274391738563
            ],
            [
              114.1818460291712,
              22.284038348782246
            ],
            [
              114.18178720555227,
              22.28402916685873
            ],
            [
              114.1817749316279,
              22.283884435404758
            ],
            [
              114.18183231394295,
              22.28387400438409
            ],
            [
              114.18188244404212,
              22.283809465728652
            ],
            [
              114.18188159683876,
              22.283218408235
            ],
            [
              114.18093309203539,
              22.28273775113884
            ],
            [
              114.18023355123051,
              22.28250212439204
            ],
            [
              114.17992794417825,
              22.283253678947744
            ],
            [
              114.18095359222741,
              22.28405851499582
            ],
            [
              114.18100295706842,
              22.284165568535386
            ],
            [
              114.18096490869857,
              22.284268050345574
            ],
            [
              114.18088261206475,
              22.28430533209874
            ],
            [
              114.1807799634608,
              22.28431019941243
            ],
            [
              114.17919779223354,
              22.28309729295175
            ],
            [
              114.1787494960065,
              22.283013914190462
            ],
            [
              114.17851821992804,
              22.283051049189822
            ],
            [
              114.17830792721077,
              22.283236973501687
            ],
            [
              114.17811572015063,
              22.28327829219961
            ],
            [
              114.17645283049688,
              22.28304599344314
            ],
            [
              114.17639061344363,
              22.283084294027887
            ],
            [
              114.17632192562314,
              22.28369824657662
            ],
            [
              114.17604990055474,
              22.28367582704861
            ],
            [
              114.1761310339632,
              22.283053665699285
            ],
            [
              114.17607967790417,
              22.283004129473284
            ],
            [
              114.17468444050434,
              22.282882473617406
            ],
            [
              114.17455225897555,
              22.282951248843176
            ],
            [
              114.17444738203875,
              22.283051515669854
            ],
            [
              114.17438917060502,
              22.283187077925675
            ],
            [
              114.174374383687,
              22.28351998680418
            ],
            [
              114.17435996697799,
              22.283792338296408
            ],
            [
              114.17449581804095,
              22.283748107659136
            ],
            [
              114.17447252371267,
              22.283693500361707
            ],
            [
              114.17462006036311,
              22.283639613719615
            ],
            [
              114.17470268709457,
              22.283958108703914
            ],
            [
              114.1745683796778,
              22.283995233037572
            ],
            [
              114.17455092814407,
              22.283935797859655
            ],
            [
              114.17445134570835,
              22.28396755132421
            ],
            [
              114.17456488005433,
              22.284342820017017
            ],
            [
              114.1745202151996,
              22.284376482080233
            ],
            [
              114.17464125926205,
              22.284396526114108
            ],
            [
              114.17441784739276,
              22.28514251188291
            ],
            [
              114.17430496077668,
              22.285170891647596
            ],
            [
              114.17419262810716,
              22.285159874225926
            ],
            [
              114.174138890378,
              22.28503878527556
            ],
            [
              114.17425725230345,
              22.28467814002188
            ],
            [
              114.1736616588164,
              22.284693274043846
            ],
            [
              114.1735364397997,
              22.284741579158435
            ],
            [
              114.17311618205088,
              22.284858449064032
            ],
            [
              114.17265194170284,
              22.28484616902253
            ],
            [
              114.17228838387786,
              22.28470201974028
            ],
            [
              114.1720059983175,
              22.284442122334312
            ],
            [
              114.17197324022578,
              22.284371841512595
            ],
            [
              114.17205856817321,
              22.28431527826713
            ],
            [
              114.17193030553653,
              22.283837166855577
            ],
            [
              114.17160380906785,
              22.283571532461224
            ],
            [
              114.17143075327039,
              22.283250496914633
            ],
            [
              114.17127609983982,
              22.28299213454703
            ],
            [
              114.17112898575601,
              22.282883302242126
            ],
            [
              114.1706885589312,
              22.282663133840487
            ],
            [
              114.17015302976063,
              22.28263512572829
            ],
            [
              114.16971841628862,
              22.282744389751272
            ],
            [
              114.1685611522671,
              22.28283780344715
            ],
            [
              114.16809599355565,
              22.282954746524524
            ],
            [
              114.1676018716089,
              22.28320502388462
            ],
            [
              114.16684660760467,
              22.283261844585894
            ],
            [
              114.16598554560466,
              22.28342229548403
            ],
            [
              114.16586711538054,
              22.283354028323657
            ],
            [
              114.16316080729308,
              22.284368810749328
            ],
            [
              114.16313703060973,
              22.28447826745024
            ],
            [
              114.16271133691816,
              22.28470428847281
            ],
            [
              114.16255351426611,
              22.285166506404337
            ],
            [
              114.16321946701589,
              22.28538552310718
            ],
            [
              114.1632377922171,
              22.285462175152787
            ],
            [
              114.16322145037344,
              22.28552045613651
            ],
            [
              114.16313827278253,
              22.28552201961034
            ],
            [
              114.16249855570015,
              22.2853229832655
            ],
            [
              114.16229777788715,
              22.285875810986795
            ],
            [
              114.162972535606,
              22.286097861636378
            ],
            [
              114.16300612442501,
              22.2861834215379
            ],
            [
              114.1629616460778,
              22.28623377169039
            ],
            [
              114.16289141819874,
              22.28623967638319
            ],
            [
              114.16222629975266,
              22.28605045421625
            ],
            [
              114.1620898144609,
              22.286378529081446
            ],
            [
              114.16234893055741,
              22.286987081229725
            ],
            [
              114.16209158170352,
              22.287090946139614
            ],
            [
              114.16184356279075,
              22.28649135511381
            ],
            [
              114.16174758537574,
              22.28645281442185
            ],
            [
              114.16124364277698,
              22.286653924323318
            ],
            [
              114.1612219533597,
              22.28677924055617
            ],
            [
              114.16146455791113,
              22.28735582303692
            ],
            [
              114.16122993612555,
              22.28745550217336
            ],
            [
              114.16096128834886,
              22.28686511921684
            ],
            [
              114.16083975330406,
              22.286800715057893
            ],
            [
              114.16037674375258,
              22.28697137607152
            ],
            [
              114.16032517208185,
              22.28704538525858
            ],
            [
              114.16054662751787,
              22.287674762059382
            ],
            [
              114.16029590590466,
              22.287744575132606
            ],
            [
              114.16006383711505,
              22.287178910959852
            ],
            [
              114.15998511507712,
              22.287110526564973
            ],
            [
              114.15948367185075,
              22.287250153239953
            ],
            [
              114.15941592276243,
              22.28736892526929
            ],
            [
              114.15958900112764,
              22.28798333182405
            ],
            [
              114.15937552845742,
              22.28803021524938
            ],
            [
              114.15917759160084,
              22.287455971585118
            ],
            [
              114.15904425847043,
              22.28740131636762
            ],
            [
              114.15857167936912,
              22.287506286436525
            ],
            [
              114.15849115815979,
              22.287636380605406
            ],
            [
              114.15866072363599,
              22.288239128084157
            ],
            [
              114.1584119645683,
              22.28830166487424
            ],
            [
              114.15823924391509,
              22.28771344228079
            ],
            [
              114.15815708092418,
              22.287610514951425
            ],
            [
              114.15762561253916,
              22.28777158684389
            ],
            [
              114.15756274461324,
              22.287835451504108
            ],
            [
              114.15775551703098,
              22.288466692380354
            ],
            [
              114.15748790543938,
              22.288540834157345
            ],
            [
              114.15732601295286,
              22.28794249459952
            ],
            [
              114.15726498986322,
              22.28783824281365
            ],
            [
              114.1567004949373,
              22.287987189253585
            ],
            [
              114.15663931089699,
              22.28803774494621
            ],
            [
              114.15682074900445,
              22.28868154692971
            ],
            [
              114.15657809745045,
              22.28873551330517
            ],
            [
              114.1564095105436,
              22.28810958540572
            ],
            [
              114.15636195305012,
              22.288051192570194
            ],
            [
              114.15613022904046,
              22.288116481765854
            ],
            [
              114.15604772382818,
              22.288249780804563
            ],
            [
              114.15579091181104,
              22.288307307215703
            ],
            [
              114.15594472385897,
              22.28890880928074
            ],
            [
              114.1557992718989,
              22.288931305379407
            ],
            [
              114.154218235737,
              22.28740724517759
            ],
            [
              114.15375930142659,
              22.287708554422906
            ],
            [
              114.15244642077761,
              22.288051430062595
            ],
            [
              114.1525931303022,
              22.288527469086617
            ],
            [
              114.15313047236509,
              22.2883987956604
            ],
            [
              114.15325587681554,
              22.28849549976721
            ],
            [
              114.15328392814536,
              22.28859103184334
            ],
            [
              114.15315767036208,
              22.288751002245064
            ],
            [
              114.15270651552413,
              22.288924032185776
            ],
            [
              114.15282206159242,
              22.289317536177762
            ],
            [
              114.15329804423772,
              22.289237491535715
            ],
            [
              114.1534380148666,
              22.28937396520577
            ],
            [
              114.15346805463662,
              22.289524869869737
            ],
            [
              114.15134165372297,
              22.290059430644817
            ],
            [
              114.15127174393592,
              22.28991854956439
            ],
            [
              114.15139150504348,
              22.28974319120681
            ],
            [
              114.15264437639485,
              22.289441433260478
            ],
            [
              114.15252045544383,
              22.288970806536156
            ],
            [
              114.15122049244695,
              22.289257994576275
            ],
            [
              114.15106116343406,
              22.28915279683089
            ],
            [
              114.15101422284351,
              22.288992935778452
            ],
            [
              114.15112184719914,
              22.28887344641089
            ],
            [
              114.15161964578652,
              22.288721893267464
            ],
            [
              114.15150655728007,
              22.28828815534348
            ],
            [
              114.15068864530087,
              22.288467364571076
            ],
            [
              114.14986145210412,
              22.289441191347834
            ],
            [
              114.14642540391014,
              22.290324641366738
            ],
            [
              114.14571592914098,
              22.290510658904623
            ],
            [
              114.14563650755912,
              22.29050873555994
            ],
            [
              114.14039099854648,
              22.290668800893016
            ],
            [
              114.13894468948996,
              22.29030032793456
            ],
            [
              114.13883825051863,
              22.29066118119799
            ],
            [
              114.13874795422407,
              22.29062492289708
            ],
            [
              114.13883864395342,
              22.29028276829203
            ],
            [
              114.13709977190791,
              22.289843393906338
            ],
            [
              114.13699713915867,
              22.29020540187777
            ],
            [
              114.13688496334714,
              22.290132739959347
            ],
            [
              114.1369844674685,
              22.289821949435847
            ],
            [
              114.13611821599466,
              22.28959424330563
            ],
            [
              114.13600022854735,
              22.289934896435582
            ],
            [
              114.13585651311269,
              22.289878568372103
            ],
            [
              114.13594296093464,
              22.289554249139243
            ],
            [
              114.13527118192809,
              22.289370110894467
            ],
            [
              114.13517084757302,
              22.289739947483284
            ],
            [
              114.13502097103049,
              22.289693573391062
            ],
            [
              114.13511284587901,
              22.289325863341773
            ],
            [
              114.13434141585981,
              22.28913792468326
            ],
            [
              114.13176287587902,
              22.28955311459022
            ],
            [
              114.13172054146685,
              22.289265987530868
            ],
            [
              114.13445303357116,
              22.288850933807467
            ],
            [
              114.13471806511063,
              22.28794277728747
            ],
            [
              114.13235182229022,
              22.288300495690663
            ],
            [
              114.12753730856457,
              22.283984871963796
            ]
                    ]]
                }
            };

            // æ³¨æ„ï¼šä¸‹æ–¹çš„ map.addSource å’Œ map.addLayer ä»£ç¢¼ä¸éœ€è¦æ”¹å‹•ï¼Œ
            // åªè¦æ›¿æ›ä¸Šé¢çš„ coordinates æ•¸æ“šï¼Œåœ°åœ–å°±æœƒè‡ªå‹•æ›´æ–°ç‚ºæ–°çš„å½¢ç‹€ã€‚

            // æ·»åŠ æ•¸æ“šæº
            map.addSource('harbour-boundary', {
                'type': 'geojson',
                'data': harbourAreaGeoJSON
            });

            // æ·»åŠ å¡«å……å±‚ (åŠ æ·±é¢œè‰²ï¼Œè®©å½¢çŠ¶æ¸…æ™°å¯è§)
            map.addLayer({
                'id': 'harbour-boundary-fill',
                'type': 'fill',
                'source': 'harbour-boundary',
                'layout': {},
                'paint': {
                    'fill-color': '#007bff',
                    'fill-opacity': 0.15  // ä» 0.1 å¢åŠ åˆ° 0.15
                }
            });

            // æ·»åŠ è½®å»“çº¿å±‚ (åŠ ç²—è™šçº¿ï¼Œå¼ºåŒ–è¾¹ç•Œæ„Ÿ)
            map.addLayer({
                'id': 'harbour-boundary-outline',
                'type': 'line',
                'source': 'harbour-boundary',
                'layout': {},
                'paint': {
                    'line-color': '#0056b3', // æ·±è“è‰²
                    'line-width': 0.5,         // åŠ ç²—çº¿æ¡
                    'line-dasharray': [4, 2], // è™šçº¿æ›´æ˜æ˜¾
                    'line-opacity': 0.9
                }
            });

            // --- ä¿®æ”¹ 5: å…‰æ¨™äº¤äº’ (ç¹ªè£½å®Œå¾Œï¼Œæ»‘é¼ æ‡¸åœåœ¨è·¯å¾‘ä¸Šé¡¯ç¤ºåå­—) ---
            // ç•¶é¼ æ¨™é€²å…¥ 'route' ç·šæ¢æ™‚
            map.on('mouseenter', 'route', () => {
                // å¦‚æœä¸æ˜¯åœ¨ç¹ªç•«æ¨¡å¼ï¼Œä¸”è·¯å¾‘å·²ç¶“å­˜åœ¨
                if (!drawMode && pathCoordinates.length > 0) {
                    map.getCanvas().style.cursor = 'crosshair'; // æ”¹ç‚ºåå­—å…‰æ¨™
                }
            });

            // ç•¶é¼ æ¨™é›¢é–‹ 'route' ç·šæ¢æ™‚
            map.on('mouseleave', 'route', () => {
                if (!drawMode) {
                    map.getCanvas().style.cursor = ''; // æ¢å¾©é»˜èª (æ‰‹æŒæˆ–ç®­é ­)
                }
            });

            statusBar.innerText = "Ready";
            updateMapLanguage(currentLang);
            renderMarkers(map);
            setupMapInteractions();
        });

    }

    let tempStopLngLat = null;

    window.confirmDuration = (duration) => {
        if (!tempStopLngLat) return;

        // è·å–åœ°ç‚¹åç§°
        const promptName = currentLang === 'en' ? "Location Name:" : (currentLang === 'zh-cn' ? "åœ°ç‚¹åç§°:" : "åœ°é»åç¨±:");
        const name = prompt(promptName);
        if (!name) { closeDurationModal(); return; }

        // æ·»åŠ æ ‡è®°
        // åˆ›å»ºæ ‡è®°ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡
        const newMarker = new mapboxgl.Marker({ color: '#2ecc71' })
            .setLngLat(tempStopLngLat)
            .addTo(map);

        // å°†è¿™ä¸ªæ ‡è®°å­˜å…¥æˆ‘ä»¬çš„ä¸“å±æ•°ç»„ï¼Œæ–¹ä¾¿åç»­å•ç‹¬åˆ é™¤
        userStopMarkers.push(newMarker);
        stopsData.push({
            lng: tempStopLngLat.lng,
            lat: tempStopLngLat.lat,
            name: name,
            duration: duration
        });

        // æ˜¾ç¤ºåœ¨åˆ—è¡¨
        document.getElementById('stops-container').style.display = 'block';
        const div = document.createElement('div');
        div.className = 'stop-item';
        div.style.flexDirection = 'column';
        div.style.alignItems = 'flex-start';
        const stayedText = currentLang === 'en' ? 'Stayed' : 'åœç•™';
        div.innerHTML = `<div style="font-weight:bold;">ğŸ“ ${name}</div><div style="font-size:11px; color:#28a745;">â±ï¸ ${stayedText}: ${duration}</div>`;
        document.getElementById('stops-list').appendChild(div);

        closeDurationModal();
        // æç¤º
        const tip = currentLang === 'en' ? "Stop added." : "åœç•™é»å·²æ·»åŠ ";
        statusBar.innerText = tip;
    };

    window.closeDurationModal = () => {
        document.getElementById('duration-modal').style.display = 'none';
        tempStopLngLat = null;
    };

<!--    function setupMapInteractions() {-->
<!--        // ç»˜å›¾æ¨¡å¼åˆ‡æ¢-->
<!--        document.getElementById('btn-draw').addEventListener('click', () => {-->
<!--            drawMode = true; map.dragPan.disable();-->
<!--            document.getElementById('map').classList.add('cursor-pen');-->
<!--            document.getElementById('btn-draw').style.display = 'none';-->
<!--            document.getElementById('btn-clear').style.display = 'inline-block';-->
<!--            statusBar.innerText = currentLang === 'en' ? "Drawing Mode: Drag to draw path" : (currentLang === 'zh-cn' ? "ç»˜ç”»æ¨¡å¼ï¼šè¯·æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡ç”»å‡ºæ‚¨çš„è¡Œèµ°è·¯çº¿" : "ç¹ªç•«æ¨¡å¼ï¼šè«‹æŒ‰ä½æ»‘é¼ /æ‰‹æŒ‡ç•«å‡ºæ‚¨çš„è¡Œèµ°è·¯ç·š");-->
<!--        });-->

<!--        document.getElementById('btn-clear').addEventListener('click', () => {-->
<!--            pathCoordinates = []; stopsData = [];-->
<!--            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } });-->
<!--            document.querySelectorAll('.mapboxgl-marker').forEach(m => m.remove());-->
<!--            document.getElementById('stops-list').innerHTML = '';-->
<!--            document.getElementById('stops-container').style.display = 'none';-->

<!--            drawMode = false; map.dragPan.enable();-->
<!--            document.getElementById('map').classList.remove('cursor-pen');-->
<!--            document.getElementById('btn-draw').style.display = 'inline-block';-->
<!--            document.getElementById('btn-clear').style.display = 'none';-->
<!--            statusBar.innerText = currentLang === 'en' ? "Cleared" : (currentLang === 'zh-cn' ? "å·²æ¸…é™¤" : "å·²æ¸…é™¤");-->
<!--        });-->

<!--        // é¼ æ ‡/è§¦æ‘¸ ç”»çº¿é€»è¾‘-->
<!--        function handleMove(coords) {-->
<!--            if (!drawMode || !isDrawing) return;-->
<!--            pathCoordinates.push(coords);-->
<!--            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': pathCoordinates } });-->
<!--        }-->

<!--        map.on('mousedown', (e) => { if(drawMode) { isDrawing = true; pathCoordinates = [[e.lngLat.lng, e.lngLat.lat]]; } });-->
<!--        map.on('mousemove', (e) => handleMove([e.lngLat.lng, e.lngLat.lat]));-->
<!--        map.on('mouseup', () => endDraw());-->

<!--        map.getCanvas().addEventListener('touchstart', (e) => {-->
<!--            if (!drawMode) return; e.preventDefault();-->
<!--            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);-->
<!--            isDrawing = true; pathCoordinates = [[loc.lng, loc.lat]];-->
<!--        }, {passive:false});-->

<!--        map.getCanvas().addEventListener('touchmove', (e) => {-->
<!--            if (!drawMode) return; e.preventDefault();-->
<!--            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);-->
<!--            handleMove([loc.lng, loc.lat]);-->
<!--        }, {passive:false});-->

<!--        map.getCanvas().addEventListener('touchend', () => endDraw());-->

<!--        function endDraw() {-->
<!--            if (!isDrawing) return;-->
<!--            isDrawing = false; drawMode = false; map.dragPan.enable();-->
<!--            document.getElementById('map').classList.remove('cursor-pen');-->

<!--            if(pathCoordinates.length > 2) {-->
<!--                const simplified = turf.simplify(turf.lineString(pathCoordinates), {tolerance: 0.0001, highQuality: true});-->
<!--                pathCoordinates = simplified.geometry.coordinates;-->
<!--                map.getSource('route').setData(simplified);-->
<!--            }-->
<!--            statusBar.innerText = currentLang === 'en'-->
<!--                ? "Path generated. Click on the path to mark stops."-->
<!--                : (currentLang === 'zh-cn' ? "è·¯å¾„å·²ç”Ÿæˆï¼Œè¯·ç‚¹å‡»è·¯å¾„ä¸Šçš„ç‚¹æ ‡è®°ç»è¿‡åŒºåŸŸæˆ–åœç•™ç‚¹" : "è·¯å¾‘å·²ç”Ÿæˆï¼Œè«‹é»æ“Šè·¯å¾‘ä¸Šçš„é»æ¨™è¨˜ç¶“éå€åŸŸæˆ–åœç•™é»");-->

<!--            // âœ… ä¿®æ”¹ç»“æŸæç¤ºï¼Œå¼ºè°ƒå¯ä»¥å¤šæ¬¡æ ‡è®°-->
<!--            const tip = currentLang === 'en'-->
<!--                ? "Path saved. Click along path to add multiple stops."-->
<!--                : "è·¯å¾‘å·²ä¿å­˜ã€‚è«‹é»æ“Šè·¯å¾‘æ¨™è¨˜åœç•™é» (å¯æ¨™è¨˜å¤šå€‹)ã€‚";-->
<!--            statusBar.innerText = tip;-->
<!--            alert(tip);-->
<!--        }-->

<!--        // ==========================================-->
<!--        // ğŸ“ æ¨™è¨˜åœç•™é»é‚è¼¯-->
<!--        // ==========================================-->
<!--        // âœ… æ’å…¥æ–°çš„ç‚¹å‡»é€»è¾‘ (å¤„ç†å¼¹çª—)-->
<!--        map.on('click', (e) => {-->
<!--            if (drawMode || pathCoordinates.length === 0) return;-->

<!--            const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);-->
<!--            const line = turf.lineString(pathCoordinates);-->
<!--            const dist = turf.pointToLineDistance(pt, line, {units: 'kilometers'});-->

<!--            if (dist > 0.3) {-->
<!--                statusBar.innerText = currentLang === 'en' ? "âš ï¸ Please click near your path" : "âš ï¸ è«‹é»æ“Šè·¯å¾‘é™„è¿‘çš„é»";-->
<!--                return;-->
<!--            }-->

<!--            tempStopLngLat = e.lngLat;-->
<!--            document.getElementById('duration-modal').style.display = 'flex';-->
<!--        });-->
<!--    }-->
    function setupMapInteractions() {
        const btnDraw = document.getElementById('btn-draw');
        const drawActions = document.getElementById('drawing-actions');
        const btnTogglePan = document.getElementById('btn-toggle-pan');
        const btnFinish = document.getElementById('btn-finish-draw');
        const btnClear = document.getElementById('btn-clear');

        // çŠ¶æ€å˜é‡
        let isPaused = false;

        // 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¼€å§‹ç»˜åˆ¶ï¼šæ¯æ¬¡ç‚¹å‡»éƒ½å¼ºåˆ¶é‡ç½®æ•°æ®ï¼Œé˜²æ­¢æ®‹ç•™
        btnDraw.addEventListener('click', () => {
            drawMode = true;
            isPaused = false;

            // --- å…³é”®ä¿®å¤ï¼šç‚¹å‡»å¼€å§‹æ—¶ï¼Œç¡®ä¿æ•°æ®æ˜¯ç©ºçš„ ---
            pathCoordinates = [];
            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } });
            // ---------------------------------------

            map.dragPan.disable(); // ç¦æ­¢æ‹–åŠ¨ï¼Œå¼€å§‹ç»˜ç”»
            document.getElementById('map').classList.add('cursor-pen');

            // åˆ‡æ¢æŒ‰é’®æ˜¾ç¤º
            btnDraw.style.display = 'none';
            drawActions.style.display = 'flex';

            // ç¡®ä¿æš‚åœæŒ‰é’®çŠ¶æ€å¤åŸ
            btnTogglePan.innerHTML = currentLang === 'en' ? "âœ‹ Pause (Move Map)" : "âœ‹ æš«åœç¹ªç•« (ç§»å‹•åœ°åœ–)";
            btnTogglePan.style.background = "#6c757d";

            updateStatusText();
        });

        // 2. åˆ‡æ¢ã€Œç»˜ç”»ã€ä¸ã€Œç§»åŠ¨åœ°å›¾ã€æ¨¡å¼
        btnTogglePan.addEventListener('click', () => {
            isPaused = !isPaused;

            if (isPaused) {
                // è¿›å…¥ç§»åŠ¨æ¨¡å¼
                map.dragPan.enable();
                document.getElementById('map').classList.remove('cursor-pen');
                btnTogglePan.innerHTML = currentLang === 'en' ? "âœï¸ Resume Drawing" : "âœï¸ ç¹¼çºŒç¹ªç•«";
                btnTogglePan.style.background = "#007bff";
                statusBar.innerText = currentLang === 'en' ? "Map Unlocked. Drag to move view." : "åœ°åœ–å·²è§£é–ï¼Œè«‹æ‹–æ‹½ç§»å‹•è¦–é‡";
            } else {
                // å›åˆ°ç»˜ç”»æ¨¡å¼
                map.dragPan.disable();
                document.getElementById('map').classList.add('cursor-pen');
                btnTogglePan.innerHTML = currentLang === 'en' ? "âœ‹ Pause (Move Map)" : "âœ‹ æš«åœç¹ªç•« (ç§»å‹•åœ°åœ–)";
                btnTogglePan.style.background = "#6c757d";
                updateStatusText();
            }
        });

        // 3. å®Œæˆç»˜åˆ¶
        btnFinish.addEventListener('click', () => {
            if (pathCoordinates.length < 2) {
                alert("Line too short / ç·šè·¯å¤ªçŸ­");
                return;
            }
            endDraw();
            // éšè—æš‚åœæŒ‰é’®ï¼Œåªç•™æ¸…é™¤
            btnTogglePan.style.display = 'none';
            btnFinish.style.display = 'none';
        });

        // 4. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æ¸…é™¤é‡ç”»ï¼šç¡®ä¿å½»åº•å¤åŸ
        btnClear.addEventListener('click', () => {
            // æ¸…ç©ºæ•°æ®
            pathCoordinates = [];
            stopsData = [];
            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } });

            // æ¸…é™¤ç”¨æˆ·æ ‡è®° (ç»¿ç‚¹)
            if (window.userStopMarkers && Array.isArray(window.userStopMarkers)) {
                window.userStopMarkers.forEach(marker => marker.remove());
                window.userStopMarkers = [];
            } else {
                // ä¿åº•é€»è¾‘ï¼šå¦‚æœæ²¡æœ‰ userStopMarkers æ•°ç»„ï¼Œåˆ™å°è¯•æ¸…é™¤æ‰€æœ‰ç»¿è‰²æ ‡è®°
                // ä½†è¿™é€šå¸¸ä¸éœ€è¦ï¼Œåªè¦ userStopMarkers å®šä¹‰æ­£ç¡®
                userStopMarkers = [];
            }

            // UI å¤åŸ
            document.getElementById('stops-list').innerHTML = '';
            document.getElementById('stops-container').style.display = 'none';

            // çŠ¶æ€å¤åŸ
            drawMode = false;
            isPaused = false;
            map.dragPan.enable(); // æ¢å¤åœ°å›¾æ‹–åŠ¨
            document.getElementById('map').classList.remove('cursor-pen');

            // æŒ‰é’®å¤åŸ
            btnDraw.style.display = 'block';
            drawActions.style.display = 'none';
            btnTogglePan.style.display = 'block';
            btnFinish.style.display = 'block';

            // æŒ‰é’®æ–‡å­—å¤åŸ
            btnTogglePan.innerHTML = currentLang === 'en' ? "âœ‹ Pause (Move Map)" : "âœ‹ æš«åœç¹ªç•« (ç§»å‹•åœ°åœ–)";
            btnTogglePan.style.background = "#6c757d";

            statusBar.innerText = "Cleared / å·²æ¸…é™¤";
        });

        // --- æ ¸å¿ƒç»˜å›¾é€»è¾‘ ---
        function handleMove(lngLat) {
            if (!drawMode || isPaused || !isDrawing) return;
            pathCoordinates.push([lngLat.lng, lngLat.lat]);
            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': pathCoordinates } });
        }

        map.on('mousedown', (e) => {
            if(drawMode && !isPaused) { isDrawing = true; handleMove(e.lngLat); }
        });
        map.on('mousemove', (e) => handleMove(e.lngLat));
        map.on('mouseup', () => { isDrawing = false; });

        // è§¦æ‘¸æ”¯æŒ
        map.getCanvas().addEventListener('touchstart', (e) => {
            if (!drawMode || isPaused) return;
            e.preventDefault();
            isDrawing = true;
            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
            handleMove(loc);
        }, {passive:false});

        map.getCanvas().addEventListener('touchmove', (e) => {
            if (!drawMode || isPaused) return;
            e.preventDefault();
            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
            handleMove(loc);
        }, {passive:false});

        map.getCanvas().addEventListener('touchend', () => { isDrawing = false; });

        function updateStatusText() {
            statusBar.innerText = currentLang === 'en'
                ? "Drawing... Click 'Pause' to move map."
                : "æ­£åœ¨ç¹ªç•«... å¦‚éœ€ç§»å‹•åœ°åœ–è«‹é»æ“Šã€Œæš«åœã€";
        }

        function endDraw() {
            drawMode = false; isPaused = false;
            map.dragPan.enable();
            document.getElementById('map').classList.remove('cursor-pen');

            if(pathCoordinates.length > 2) {
                const simplified = turf.simplify(turf.lineString(pathCoordinates), {tolerance: 0.0001, highQuality: true});
                pathCoordinates = simplified.geometry.coordinates;
                map.getSource('route').setData(simplified);
            }

            const tip = currentLang === 'en'
                ? "Path saved. Click along path to add stops."
                : "è·¯å¾‘å·²ä¿å­˜ã€‚è«‹é»æ“Šè·¯å¾‘æ¨™è¨˜åœç•™é» (å¯æ¨™è¨˜å¤šå€‹)ã€‚";
            statusBar.innerText = tip;
            alert(tip);
        }

        // æ ‡è®°åœç•™ç‚¹
        map.on('click', (e) => {
            if (drawMode) return;
            if (pathCoordinates.length === 0) return;

            const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);
            const line = turf.lineString(pathCoordinates);
            const dist = turf.pointToLineDistance(pt, line, {units: 'kilometers'});

            if (dist > 0.3) {
                statusBar.innerText = currentLang === 'en' ? "âš ï¸ Too far from path" : "âš ï¸ è«‹é»æ“Šè·¯å¾‘é™„è¿‘çš„é»";
                return;
            }

            tempStopLngLat = e.lngLat;
            document.getElementById('duration-modal').style.display = 'flex';
        });
    }
    // å¯åŠ¨
    setTimeout(initApp, 500);

    // ==========================================
    // æäº¤é€»è¾‘
    // ==========================================
    document.getElementById('btn-submit').addEventListener('click', async () => {
        const btn = document.getElementById('btn-submit');
        const formData = {};

        document.querySelectorAll('input:checked').forEach(input => {
            const name = input.name;
            const val = input.value;
            if (formData[name]) {
                if (!Array.isArray(formData[name])) formData[name] = [formData[name]];
                formData[name].push(val);
            } else {
                formData[name] = val;
            }
        });

        if (pathCoordinates.length === 0) {
            alert(currentLang === 'en'
                ? "Please draw your route on the map!"
                : (currentLang === 'zh-cn' ? "è¯·åœ¨ç¬¬ä¸‰éƒ¨åˆ†ç»˜åˆ¶æ‚¨çš„è¡Œèµ°è·¯çº¿ï¼" : "è«‹åœ¨ç¬¬ä¸‰éƒ¨åˆ†ç¹ªè£½æ‚¨çš„è¡Œèµ°è·¯ç·šï¼"));
            return;
        }

        btn.disabled = true; btn.innerText = "...";

        const result = await window.submitToFirebase({
            answers: formData,
            path: JSON.stringify(pathCoordinates),
            stops: stopsData,
            timestamp: new Date().toISOString(),
            lang: currentLang
        });

        if (result.success) {
            const todayStr = new Date().toISOString().split('T')[0];
            localStorage.setItem('survey_last_submit_date', todayStr);

            alert("æäº¤æˆåŠŸ / Submitted Successfully! ID: " + result.id);
            location.reload();
        } else {
            alert("Error: " + result.error);
            btn.disabled = false; btn.innerText = "Retry";
        }
<!--        if (result.success) {-->
<!--            // âœ… 1. è·å–ä»Šæ—¥æ—¥æœŸ-->
<!--            const todayStr = getLocalTodayDate();-->

<!--            // âœ… 2. è¯»å–æ—§çš„è®¡æ•° (é˜²æ­¢æ˜¯ NaN)-->
<!--            let currentCount = parseInt(localStorage.getItem('survey_daily_count') || '0');-->
<!--            const lastDate = localStorage.getItem('survey_last_submit_date');-->

<!--            // å¦‚æœæœ¬åœ°è®°å½•çš„æ—¥æœŸä¸æ˜¯ä»Šå¤©ï¼ˆæ¯”å¦‚æ˜¨å¤©å¡«è¿‡ï¼‰ï¼Œåˆ™é‡ç½®è®¡æ•°ä¸º 0-->
<!--            if (lastDate !== todayStr) {-->
<!--                currentCount = 0;-->
<!--            }-->

<!--            // âœ… 3. è®¡æ•°å™¨ +1-->
<!--            currentCount++;-->

<!--            // âœ… 4. ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜-->
<!--            localStorage.setItem('survey_last_submit_date', todayStr);-->
<!--            localStorage.setItem('survey_daily_count', currentCount.toString());-->

<!--            console.log(`æäº¤æˆåŠŸï¼ä»Šæ—¥å·²å¡«æ¬¡æ•°: ${currentCount}`);-->

<!--            // âœ… 5. éšè—é—®å·å’Œåœ°å›¾ï¼Œæ˜¾ç¤ºæ„Ÿè°¢é®ç½© (ä¸åˆ·æ–°é¡µé¢)-->
<!--            document.getElementById('sidebar').style.display = 'none';-->
<!--            document.getElementById('map').style.display = 'none';-->
<!--            document.getElementById('submitted-mask').style.display = 'flex';-->

<!--            // æ›´æ–°é®ç½©ä¸Šçš„æ–‡å­—æç¤º (å¯é€‰)-->
<!--            const maskDesc = document.querySelector('#submitted-mask p');-->
<!--            if (maskDesc) {-->
<!--                maskDesc.innerHTML = `You have submitted ${currentCount} time(s) today.<br>æ‚¨ä»Šå¤©å·²æˆåŠŸæäº¤ ${currentCount} æ¬¡ã€‚`;-->
<!--            }-->

<!--        } else {-->
<!--            alert("Error: " + result.error);-->
<!--            btn.disabled = false; btn.innerText = "Retry";-->
<!--        }-->
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Victoria Harbour Survey</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        /* ================= åŸºç¡€æ ·å¼ ================= */
        body { margin: 0; padding: 0; display: flex; font-family: "Helvetica Neue", Helvetica, "PingFang TC", "PingFang SC", "Microsoft JhengHei", "Microsoft YaHei", Arial, sans-serif; height: 100vh; overflow: hidden; color: #333; }

        /* å¸ƒå±€ï¼šå·¦ä¾§é—®å·ï¼Œå³ä¾§åœ°å›¾ */
        #sidebar { width: 400px; background: #f8f9fa; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; display: flex; flex-direction: column; }
        #map { flex-grow: 1; position: relative; }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; }
            #sidebar { width: 100%; height: 50vh; padding: 15px; }
            #map { height: 50vh; width: 100%; }
        }

        h2 { font-size: 1.1rem; margin-top: 0; color: #2c3e50; }
        h3 { font-size: 0.95rem; margin: 15px 0 5px 0; color: #666; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        p { font-size: 0.85rem; color: #666; line-height: 1.4; margin-bottom: 10px; }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        .q-item { margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .q-label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; }

        /* å•é€‰ & å¤šé€‰ */
        .radio-group label, .checkbox-group label { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.9rem; cursor: pointer; }
        .radio-group input, .checkbox-group input { margin-right: 8px; accent-color: #007bff; }

        /* çŸ©é˜µé¢˜è¡¨æ ¼ (æ»¡æ„åº¦è¯„åˆ†) */
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .matrix-table th, .matrix-table td { border-bottom: 1px solid #eee; padding: 8px 4px; text-align: center; }
        .matrix-table th:first-child, .matrix-table td:first-child { text-align: left; width: 40%; font-weight: normal; }
        .matrix-table th { background: #f1f3f5; color: #495057; }

        /* æŒ‰é’® */
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; margin-top: auto; font-size: 1rem; }

        /* è¯­è¨€åˆ‡æ¢ */
        .lang-switch { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 15px; }
        .lang-btn { background: none; border: 1px solid #ccc; padding: 4px 10px; font-size: 12px; cursor: pointer; width: auto; margin-top: 0; color: #666; }
        .lang-btn.active { background: #333; color: white; border-color: #333; }

        /* åœ°å›¾çŠ¶æ€ä¸åˆ—è¡¨ */
        .cursor-pen .mapboxgl-canvas-container { cursor: crosshair !important; }
        #stops-list { font-size: 0.85rem; max-height: 150px; overflow-y: auto; margin-top: 5px;}
        .stop-item { background: #fff; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.8rem; display: flex; justify-content: space-between; }
        #status-bar { position: absolute; top: 10px; left: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 4px; font-size: 13px; text-align: center; pointer-events: none; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å…¬å‘Šæ æ ·å¼ */
        #announcement-bar { background: #fff3cd; color: #856404; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ffeeba; display: none; font-size: 0.85rem; }
        /* è°ƒæŸ¥å…³é—­é®ç½© */
        #closed-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; display: none; }
    </style>
</head>
<body>

<!-- è°ƒæŸ¥å…³é—­æç¤ºå±‚ -->
<div id="closed-mask">
    <h2>ğŸ”’ Survey Closed / èª¿æŸ¥å·²çµæŸ</h2>
    <p>Thank you for your interest.</p>
</div>
<!-- å·²å®Œæˆä»Šæ—¥è°ƒæŸ¥çš„æç¤º -->
<div id="submitted-mask" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; text-align: center; display: none;">
    <h2 style="font-size: 2rem; color: #28a745; margin-bottom: 10px;">âœ…</h2>
    <h2 style="color: #333;">Thank You! / æ„Ÿè¬åƒèˆ‡</h2>
    <p style="color: #666; padding: 0 20px;">
        You have already submitted the survey today.<br>
        æ‚¨ä»Šå¤©å·²ç¶“å¡«å¯«éå•å·äº†ï¼Œæ„Ÿè¬æ‚¨çš„å¯¶è²´æ„è¦‹ã€‚
    </p>
</div>

<div id="sidebar">
    <div class="lang-switch">
        <button class="lang-btn" onclick="setLang('en')">English</button>
        <button class="lang-btn active" onclick="setLang('zh-tw')">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLang('zh-cn')">ç®€ä½“ä¸­æ–‡</button>
    </div>

    <!-- å…¬å‘Šæ  -->
    <div id="announcement-bar"></div>

    <h2 id="txt-title">ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥</h2>
    <p id="txt-intro">ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚</p>

    <form id="survey-form">
        <div id="dynamic-form-container"></div>
    </form>

    <div class="q-item" style="border-left: 4px solid #007bff;">
        <label class="q-label" id="lbl-map-task">ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)</label>
        <p style="font-size:12px; color:#666;" id="txt-map-hint">
            1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>
            2. ç•«å®Œå¾Œï¼Œé»æ“Šç·šä¸Šçš„é»æ¨™è¨˜æ‚¨<b>ç¶“éçš„å€åŸŸ</b>æˆ–<b>åœç•™é»</b>ã€‚
        </p>

        <button type="button" id="btn-draw" class="btn-primary">âœï¸ <span id="txt-draw">é–‹å§‹ç¹ªè£½è·¯ç·š</span></button>
        <button type="button" id="btn-clear" class="btn-danger" style="display:none;">ğŸ—‘ï¸ <span id="txt-clear">æ¸…é™¤é‡ç•«</span></button>

        <div id="stops-container" style="margin-top:10px; display:none;">
            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:5px;">å·²æ¨™è¨˜çš„å€åŸŸ/åœç•™é»ï¼š</div>
            <div id="stops-list"></div>
        </div>
    </div>

    <button type="button" id="btn-submit" class="btn-success">âœ… <span id="txt-submit">æäº¤å•å·</span></button>
    <div style="height: 30px;"></div>
</div>

<div id="map">
    <div id="status-bar">Loading map...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ğŸ”´ 1. å¡«å…¥ä½ çš„ Firebase é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyC7VlOkfjsMJyLjeNOfUKRBC7tUKDwBw4c",
        authDomain: "seafrontcorridor.firebaseapp.com",
        databaseURL: "https://seafrontcorridor-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "seafrontcorridor",
        storageBucket: "seafrontcorridor.firebasestorage.app",
        messagingSenderId: "254023717334",
        appId: "1:254023717334:web:cbb2a9bce184b1d2409477",
        measurementId: "G-DECCS32PFD"
    };

    let db;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
    } catch(e) { console.error(e); }

    window.submitToFirebase = async (data) => {
        if (!db) return { success: false, error: "Database not connected" };
        try {
            const docRef = await addDoc(collection(db, "victoria_harbour_survey"), data);
            return { success: true, id: docRef.id };
        } catch (e) {
            return { success: false, error: e.message };
        }
    };

    window.fetchSurveyConfig = async () => {
        if (!db) return null;
        try {
            const docRef = doc(db, "config", "survey_settings");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                return docSnap.data();
            } else {
                return null;
            }
        } catch (e) {
            console.error("Error fetching config:", e);
            return null;
        }
    };
</script>

<script>
    // ==========================================
    // ğŸ› ï¸ ä¿®æ”¹ä½ç½® 1ï¼šç¡®ä¿æœ‰è¿™ä¸ªç»Ÿä¸€çš„è·å–æ—¥æœŸå‡½æ•°
    // ==========================================
    function getLocalTodayDate() {
        const d = new Date();
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`; // è¿”å›æ ¼å¼ä¾‹å¦‚ "2026-01-17"
    }
    // ==========================================
    // ğŸŸ¢ é—®å·é…ç½® (å¢åŠ ç®€ä½“ä¸­æ–‡ zh-cn)
    // ==========================================
    const surveyConfig = [
        // --- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬èµ„æ–™ ---
        { type: 'header', label: { en: 'Part 1: Demographics', 'zh-tw': 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬è³‡æ–™', 'zh-cn': 'ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºæœ¬èµ„æ–™' } },
        {
            id: 'age', type: 'radio',
            label: { en: '1. What is your age group?', 'zh-tw': '1. æ‚¨çš„å¹´é½¡æ®µæ˜¯ï¼Ÿ', 'zh-cn': '1. æ‚¨çš„å¹´é¾„æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '18-30', text: { en: '18-30', 'zh-tw': '18-30æ­²', 'zh-cn': '18-30å²' } },
                { val: '31-50', text: { en: '31-50', 'zh-tw': '31-50æ­²', 'zh-cn': '31-50å²' } },
                { val: '51-65', text: { en: '51-65', 'zh-tw': '51-65æ­²', 'zh-cn': '51-65å²' } },
                { val: '65+', text: { en: 'Over 65', 'zh-tw': '65æ­²ä»¥ä¸Š', 'zh-cn': '65å²ä»¥ä¸Š' } }
            ]
        },
        {
            id: 'gender', type: 'radio',
            label: { en: '2. Gender', 'zh-tw': '2. æ‚¨çš„æ€§åˆ¥ï¼š', 'zh-cn': '2. æ‚¨çš„æ€§åˆ«ï¼š' },
            options: [
                { val: 'M', text: { en: 'Male', 'zh-tw': 'ç”·', 'zh-cn': 'ç”·' } },
                { val: 'F', text: { en: 'Female', 'zh-tw': 'å¥³', 'zh-cn': 'å¥³' } }
            ]
        },
        {
            id: 'identity', type: 'radio',
            label: { en: '3. Residency status', 'zh-tw': '3. æ‚¨çš„èº«ä»½æ˜¯ï¼Ÿ', 'zh-cn': '3. æ‚¨çš„èº«ä»½æ˜¯ï¼Ÿ' },
            options: [
                { val: 'Resident', text: { en: 'HK Resident', 'zh-tw': 'é¦™æ¸¯å±…æ°‘', 'zh-cn': 'é¦™æ¸¯å±…æ°‘' } },
                { val: 'Tourist', text: { en: 'Tourist', 'zh-tw': 'éŠå®¢', 'zh-cn': 'æ¸¸å®¢' } }
            ]
        },

        // --- ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è®¿é—®ä¿¡æ¯ ---
        { type: 'header', label: { en: 'Part 2: Basic Visit Info', 'zh-tw': 'ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è¨ªå•è³‡è¨Š', 'zh-cn': 'ç¬¬äºŒéƒ¨åˆ†ï¼šåŸºæœ¬è®¿é—®ä¿¡æ¯' } },
        {
            id: 'frequency', type: 'radio',
            label: { en: '1. Visit frequency', 'zh-tw': '1. æ‚¨è¨ªå•æµ·æ¿±é•·å»Šçš„é »ç‡æ˜¯ï¼Ÿ', 'zh-cn': '1. æ‚¨è®¿é—®æµ·æ»¨é•¿å»Šçš„é¢‘ç‡æ˜¯ï¼Ÿ' },
            options: [
                { val: 'daily', text: { en: 'Almost daily', 'zh-tw': 'å¹¾ä¹æ¯å¤©', 'zh-cn': 'å‡ ä¹æ¯å¤©' } },
                { val: '3-4w', text: { en: '3-4 times/week', 'zh-tw': 'æ¯å‘¨3-4æ¬¡', 'zh-cn': 'æ¯å‘¨3-4æ¬¡' } },
                { val: '1-2w', text: { en: '1-2 times/week', 'zh-tw': 'æ¯å‘¨1-2æ¬¡', 'zh-cn': 'æ¯å‘¨1-2æ¬¡' } },
                { val: '1-2m', text: { en: '1-2 times/month', 'zh-tw': 'æ¯æœˆ1-2æ¬¡', 'zh-cn': 'æ¯æœˆ1-2æ¬¡' } },
                { val: 'rarely', text: { en: 'Rarely', 'zh-tw': 'å¾ˆå°‘', 'zh-cn': 'å¾ˆå°‘' } }
            ]
        },
        {
            id: 'day', type: 'radio',
            label: { en: '2. Visit day', 'zh-tw': '2. æ‚¨ä»Šå¤©æ˜¯æ˜ŸæœŸå¹¾ä¾†è¨ªï¼Ÿ', 'zh-cn': '2. æ‚¨ä»Šå¤©æ˜¯æ˜ŸæœŸå‡ æ¥è®¿ï¼Ÿ' },
            options: [
                { val: 'weekday', text: { en: 'Weekday', 'zh-tw': 'å·¥ä½œæ—¥', 'zh-cn': 'å·¥ä½œæ—¥' } },
                { val: 'weekend', text: { en: 'Weekend/Holiday', 'zh-tw': 'é€±æœ«æˆ–å…¬çœ¾å‡æœŸ', 'zh-cn': 'å‘¨æœ«æˆ–å…¬ä¼—å‡æœŸ' } }
            ]
        },
        {
            id: 'arrival_time', type: 'radio',
            label: { en: '3. Arrival time', 'zh-tw': '3. æ‚¨åˆ°é”é€™è£¡çš„å…·é«”æ™‚é–“æ®µæ˜¯ï¼Ÿ', 'zh-cn': '3. æ‚¨åˆ°è¾¾è¿™é‡Œçš„å…·ä½“æ—¶é—´æ®µæ˜¯ï¼Ÿ' },
            options: [
                { val: '12-14', text: { en: '12:00-14:00', 'zh-tw': '12:00-14:00 (åˆé–“)', 'zh-cn': '12:00-14:00 (åˆé—´)' } },
                { val: '14-17', text: { en: '14:00-17:00', 'zh-tw': '14:00-17:00 (ä¸‹åˆ)', 'zh-cn': '14:00-17:00 (ä¸‹åˆ)' } },
                { val: '17-19', text: { en: '17:00-19:00', 'zh-tw': '17:00-19:00 (å‚æ™š)', 'zh-cn': '17:00-19:00 (å‚æ™š)' } },
                { val: 'other', text: { en: 'Other', 'zh-tw': 'å…¶ä»–æ™‚é–“', 'zh-cn': 'å…¶ä»–æ—¶é—´' } }
            ]
        },

        // --- ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ ---
        { type: 'header', label: { en: 'Part 3: Activities', 'zh-tw': 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡èˆ‡åœç•™', 'zh-cn': 'ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ä¸åœç•™' } },
        {
            id: 'purpose', type: 'checkbox',
            label: { en: '1. Main purpose (Multiple)', 'zh-tw': '1. æ‚¨ä»Šå¤©ä¸»è¦çš„æ´»å‹•ç›®çš„æ˜¯ï¼Ÿ(å¯å¤šé¸)', 'zh-cn': '1. æ‚¨ä»Šå¤©ä¸»è¦çš„æ´»åŠ¨ç›®çš„æ˜¯ï¼Ÿ(å¯å¤šé€‰)' },
            options: [
                { val: 'walk', text: { en: 'Strolling', 'zh-tw': 'æ•£æ­¥/é–’é€›', 'zh-cn': 'æ•£æ­¥/é—²é€›' } },
                { val: 'run', text: { en: 'Running', 'zh-tw': 'è·‘æ­¥/é›ç…‰', 'zh-cn': 'è·‘æ­¥/é”»ç‚¼' } },
                { val: 'rest', text: { en: 'Resting', 'zh-tw': 'ä¼‘æ¯/ç™¼å‘†', 'zh-cn': 'ä¼‘æ¯/å‘å‘†' } },
                { val: 'pass', text: { en: 'Commuting', 'zh-tw': 'é€šå‹¤(è·¯é)', 'zh-cn': 'é€šå‹¤(è·¯è¿‡)' } },
                { val: 'photo', text: { en: 'Photography', 'zh-tw': 'æ¬£è³é¢¨æ™¯/æ‹ç…§', 'zh-cn': 'æ¬£èµé£æ™¯/æ‹ç…§' } }
            ]
        },
        {
            id: 'rest_spot', type: 'checkbox',
            label: { en: '4. Preferred resting spot', 'zh-tw': '4. å¦‚æœåœä¸‹ä¾†ä¼‘æ¯ï¼Œé€šå¸¸é¸æ“‡å“ªè£¡ï¼Ÿ', 'zh-cn': '4. å¦‚æœåœä¸‹æ¥ä¼‘æ¯ï¼Œé€šå¸¸é€‰æ‹©å“ªé‡Œï¼Ÿ' },
            options: [
                { val: 'bench', text: { en: 'Bench', 'zh-tw': 'é•·æ¤…æˆ–åº§æ¤…å€', 'zh-cn': 'é•¿æ¤…æˆ–åº§æ¤…åŒº' } },
                { val: 'lawn', text: { en: 'Lawn', 'zh-tw': 'è‰åªæˆ–ç¶ åœ°', 'zh-cn': 'è‰åªæˆ–ç»¿åœ°' } },
                { val: 'railing', text: { en: 'By railing', 'zh-tw': 'é è¿‘æ¬„æ†çš„æµ·é‚Š', 'zh-cn': 'é è¿‘æ æ†çš„æµ·è¾¹' } },
                { val: 'shade', text: { en: 'Under shade', 'zh-tw': 'æ¨¹è”­ä¸‹', 'zh-cn': 'æ ‘è«ä¸‹' } },
                { val: 'art', text: { en: 'Near art', 'zh-tw': 'è—è¡“è£ç½®é™„è¿‘', 'zh-cn': 'è‰ºæœ¯è£…ç½®é™„è¿‘' } }
            ]
        },

        // --- ç¬¬å››éƒ¨åˆ†ï¼šç¯å¢ƒæ„ŸçŸ¥ ---
        { type: 'header', label: { en: 'Part 4: Perception', 'zh-tw': 'ç¬¬å››éƒ¨åˆ†ï¼šç’°å¢ƒæ„ŸçŸ¥èˆ‡è©•åƒ¹', 'zh-cn': 'ç¬¬å››éƒ¨åˆ†ï¼šç¯å¢ƒæ„ŸçŸ¥ä¸è¯„ä»·' } },
        {
            id: 'reason_visit', type: 'checkbox',
            label: { en: '1&2. Reason for visiting at this time (Optional)', 'zh-tw': '1&2. æ‚¨é¸æ“‡ç¾åœ¨ä¾†è¨ªä¸»è¦æ˜¯å› ç‚ºï¼Ÿ(å¯å¤šé¸)', 'zh-cn': '1&2. æ‚¨é€‰æ‹©ç°åœ¨æ¥è®¿ä¸»è¦æ˜¯å› ä¸ºï¼Ÿ(å¯å¤šé€‰)' },
            options: [
                { val: 'sun', text: { en: 'Sunlight', 'zh-tw': 'äº«å—é™½å…‰', 'zh-cn': 'äº«å—é˜³å…‰' } },
                { val: 'cool', text: { en: 'Cooler temp', 'zh-tw': 'æ°£æº«èˆ’é©/è¼ƒæ¶¼çˆ½', 'zh-cn': 'æ°”æ¸©èˆ’é€‚/è¾ƒå‡‰çˆ½' } },
                { val: 'lunch', text: { en: 'Lunch break', 'zh-tw': 'åˆä¼‘ä¾¿åˆ©', 'zh-cn': 'åˆä¼‘ä¾¿åˆ©' } },
                { val: 'nightview', text: { en: 'Night view', 'zh-tw': 'å¤œæ™¯/ç‡ˆå…‰', 'zh-cn': 'å¤œæ™¯/ç¯å…‰' } },
                { val: 'sunset', text: { en: 'Sunset', 'zh-tw': 'è§€è³æ—¥è½', 'zh-cn': 'è§‚èµæ—¥è½' } }
            ]
        },
        {
            id: 'satisfaction', type: 'matrix',
            label: { en: '3. Satisfaction Rating (1-5)', 'zh-tw': '3. è«‹å°ã€Œè¨­æ–½èˆ‡ç’°å¢ƒã€æ»¿æ„åº¦è©•åˆ† (1-5åˆ†)', 'zh-cn': '3. è¯·å¯¹â€œè®¾æ–½ä¸ç¯å¢ƒâ€æ»¡æ„åº¦è¯„åˆ† (1-5åˆ†)' },
            rows: [
                { id: 'seat', text: { en: 'Seating', 'zh-tw': 'åº§æ¤…æ•¸é‡èˆ‡èˆ’é©åº¦', 'zh-cn': 'åº§æ¤…æ•°é‡ä¸èˆ’é€‚åº¦' } },
                { id: 'shade', text: { en: 'Shading', 'zh-tw': 'é®é™½/é®é›¨è¨­æ–½', 'zh-cn': 'é®é˜³/é®é›¨è®¾æ–½' } },
                { id: 'green', text: { en: 'Greenery', 'zh-tw': 'ç¶ åŒ–æ™¯è§€', 'zh-cn': 'ç»¿åŒ–æ™¯è§‚' } },
                { id: 'seaview', text: { en: 'Sea view', 'zh-tw': 'è¦ªæµ·è¦–é‡', 'zh-cn': 'äº²æµ·è§†é‡' } },
                { id: 'art', text: { en: 'Art', 'zh-tw': 'è—è¡“èˆ‡äº’å‹•è£ç½®', 'zh-cn': 'è‰ºæœ¯ä¸äº’åŠ¨è£…ç½®' } },
                { id: 'commercial', text: { en: 'Facilities', 'zh-tw': 'å•†æ¥­è¨­æ–½(è²©è³£æ©Ÿç­‰)', 'zh-cn': 'å•†ä¸šè®¾æ–½(è´©å–æœºç­‰)' } }
            ],
            cols: ['1', '2', '3', '4', '5']
        },
        {
            id: 'attraction', type: 'radio',
            label: { en: '4. Factor for staying long', 'zh-tw': '4. å“ªå€‹å› ç´ æœ€èƒ½å¸å¼•æ‚¨é•·æ™‚é–“åœç•™ï¼Ÿ', 'zh-cn': '4. å“ªä¸ªå› ç´ æœ€èƒ½å¸å¼•æ‚¨é•¿æ—¶é—´åœç•™ï¼Ÿ' },
            options: [
                { val: 'view', text: { en: 'Sea view', 'zh-tw': 'å¯¬é—Šçš„æµ·æ™¯', 'zh-cn': 'å®½é˜”çš„æµ·æ™¯' } },
                { val: 'green', text: { en: 'Greenery', 'zh-tw': 'è±å¯Œçš„ç¶ æ¤', 'zh-cn': 'ä¸°å¯Œçš„ç»¿æ¤' } },
                { val: 'seat', text: { en: 'Comfort', 'zh-tw': 'èˆ’é©çš„åº§æ¤…', 'zh-cn': 'èˆ’é€‚çš„åº§æ¤…' } },
                { val: 'art', text: { en: 'Art', 'zh-tw': 'ç¨ç‰¹çš„è—è¡“è£ç½®', 'zh-cn': 'ç‹¬ç‰¹çš„è‰ºæœ¯è£…ç½®' } },
                { val: 'shade', text: { en: 'Shade', 'zh-tw': 'é®é™½é¿æš‘', 'zh-cn': 'é®é˜³é¿æš‘' } }
            ]
        }
    ];

    // ==========================================
    // æ¸²æŸ“è¡¨å•é€»è¾‘
    // ==========================================
    let currentLang = 'zh-tw';

    function renderForm() {
        const container = document.getElementById('dynamic-form-container');
        container.innerHTML = '';

        surveyConfig.forEach(q => {
            if (q.type === 'header') {
                const h3 = document.createElement('h3');
                h3.innerText = q.label[currentLang];
                container.appendChild(h3);
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'q-item';

            const label = document.createElement('label');
            label.className = 'q-label';
            label.innerText = q.label[currentLang];
            wrapper.appendChild(label);

            if (q.type === 'radio') {
                const group = document.createElement('div');
                group.className = 'radio-group';
                q.options.forEach(opt => {
                    const l = document.createElement('label');
                    l.innerHTML = `<input type="radio" name="${q.id}" value="${opt.val}"> ${opt.text[currentLang]}`;
                    group.appendChild(l);
                });
                wrapper.appendChild(group);
            }
            else if (q.type === 'checkbox') {
                const group = document.createElement('div');
                group.className = 'checkbox-group';
                q.options.forEach(opt => {
                    const l = document.createElement('label');
                    l.innerHTML = `<input type="checkbox" name="${q.id}" value="${opt.val}"> ${opt.text[currentLang]}`;
                    group.appendChild(l);
                });
                wrapper.appendChild(group);
            }
            else if (q.type === 'matrix') {
                const table = document.createElement('table');
                table.className = 'matrix-table';

                const thead = document.createElement('tr');
                thead.innerHTML = `<th>${currentLang === 'en' ? 'Factor' : 'è¦ç´ '}</th>${q.cols.map(c => `<th>${c}</th>`).join('')}`;
                table.appendChild(thead);

                q.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    let tds = `<td>${row.text[currentLang]}</td>`;
                    q.cols.forEach(colVal => {
                        tds += `<td><input type="radio" name="${q.id}_${row.id}" value="${colVal}"></td>`;
                    });
                    tr.innerHTML = tds;
                    table.appendChild(tr);
                });
                wrapper.appendChild(table);
            }

            container.appendChild(wrapper);
        });
    }

    // è¯­è¨€åˆ‡æ¢é€»è¾‘
    window.setLang = (lang) => {
        currentLang = lang;
        renderForm();

        // æ›´æ–°å›ºå®šæ–‡æœ¬
        const texts = {
            'en': { title: "Survey on Victoria Harbour Promenade", intro: "This study aims to understand user behavior and experience.", map: "Part 3: Activity Trajectory (Draw on Map)", mapHint: "1. Click 'Start Drawing' to trace your route.\n2. Click on the line to mark spots visited.", draw: "Start Drawing", clear: "Redraw", submit: "Submit Survey" },
            'zh-tw': { title: "ç¶­å¤šåˆ©äºæ¸¯æµ·æ¿±é•·å»Šä½¿ç”¨é«”é©—èª¿æŸ¥", intro: "ç ”ç©¶èªªæ˜ï¼šæœ¬å•å·æ—¨åœ¨æ¢è¨æµ·æ¿±æ­¥é“çš„ä½¿ç”¨è¡Œç‚ºèˆ‡é«”é©—ã€‚æ‰€æœ‰è³‡æ–™çµ•å°ä¿å¯†ã€‚", map: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»å‹•è»Œè·¡ (è«‹åœ¨åœ°åœ–ä¸Šç¹ªè£½)", mapHint: "1. é»æ“Šã€Œé–‹å§‹ç¹ªè£½ã€ç•«å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯ç·š</b>ã€‚<br>2. ç•«å®Œå¾Œï¼Œé»æ“Šç·šä¸Šçš„é»æ¨™è¨˜æ‚¨<b>ç¶“éçš„å€åŸŸ</b>æˆ–<b>åœç•™é»</b>ã€‚", draw: "é–‹å§‹ç¹ªè£½è·¯ç·š", clear: "æ¸…é™¤é‡ç•«", submit: "æäº¤å•å·" },
            'zh-cn': { title: "ç»´å¤šåˆ©äºšæ¸¯æµ·æ»¨é•¿å»Šä½¿ç”¨ä½“éªŒè°ƒæŸ¥", intro: "ç ”ç©¶è¯´æ˜ï¼šæœ¬é—®å·æ—¨åœ¨æ¢è®¨æµ·æ»¨æ­¥é“çš„ä½¿ç”¨è¡Œä¸ºä¸ä½“éªŒã€‚æ‰€æœ‰èµ„æ–™ç»å¯¹ä¿å¯†ã€‚", map: "ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ´»åŠ¨è½¨è¿¹ (è¯·åœ¨åœ°å›¾ä¸Šç»˜åˆ¶)", mapHint: "1. ç‚¹å‡»â€œå¼€å§‹ç»˜åˆ¶â€ç”»å‡ºæ‚¨çš„<b>è¡Œèµ°è·¯çº¿</b>ã€‚<br>2. ç”»å®Œåï¼Œç‚¹å‡»çº¿ä¸Šçš„ç‚¹æ ‡è®°æ‚¨<b>ç»è¿‡çš„åŒºåŸŸ</b>æˆ–<b>åœç•™ç‚¹</b>ã€‚", draw: "å¼€å§‹ç»˜åˆ¶è·¯çº¿", clear: "æ¸…é™¤é‡ç”»", submit: "æäº¤é—®å·" }
        };
        document.getElementById('txt-title').innerText = texts[lang].title;
        document.getElementById('txt-intro').innerText = texts[lang].intro;
        document.getElementById('lbl-map-task').innerText = texts[lang].map;
        document.getElementById('txt-map-hint').innerHTML = texts[lang].mapHint;
        document.getElementById('txt-draw').innerText = texts[lang].draw;
        document.getElementById('txt-clear').innerText = texts[lang].clear;
        document.getElementById('txt-submit').innerText = texts[lang].submit;

        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`button[onclick="setLang('${lang}')"]`).classList.add('active');

        // âœ¨ åˆ‡æ¢åœ°å›¾è¯­è¨€
        updateMapLanguage(lang);
    };

    // ğŸŸ¢ æ–°å¢ï¼šæ›´æ–°åœ°å›¾è¯­è¨€å‡½æ•°
    function updateMapLanguage(langCode) {
        if (!map || !map.getStyle()) return;

        const style = map.getStyle();
        if (!style.layers) return;

        // Mapbox Streets é»˜è®¤åŒ…å« name_en, name_zh-Hant, name_zh-Hans å­—æ®µ
        // æˆ‘ä»¬éå†æ‰€æœ‰æ–‡å­—å±‚ï¼Œå¼ºåˆ¶æ›´æ”¹ text-field å±æ€§
        const labelLayers = style.layers.filter(layer =>
            layer.type === 'symbol' && layer.layout && layer.layout['text-field']
        );

        let textFieldValue = ['get', 'name']; // é»˜è®¤æœ¬åœ°è¯­è¨€

        if (langCode === 'en') {
            textFieldValue = ['coalesce', ['get', 'name_en'], ['get', 'name']];
        } else if (langCode === 'zh-tw') {
            textFieldValue = ['coalesce', ['get', 'name_zh-Hant'], ['get', 'name']];
        } else if (langCode === 'zh-cn') {
            textFieldValue = ['coalesce', ['get', 'name_zh-Hans'], ['get', 'name']];
        }

        labelLayers.forEach(layer => {
            // åªä¿®æ”¹åŒ…å« 'name' å­—æ®µçš„å›¾å±‚ï¼Œé¿å…ä¿®æ”¹å›¾æ ‡æˆ–å…¶ä»–çº¯æ ¼å¼å›¾å±‚
            try {
                // åˆ¤æ–­å½“å‰å›¾å±‚çš„ text-field æ˜¯å¦ä¾èµ–äº name
                const currentField = JSON.stringify(layer.layout['text-field']);
                if (currentField.includes('name')) {
                     map.setLayoutProperty(layer.id, 'text-field', textFieldValue);
                }
            } catch(e) { console.log(e); }
        });
    }

    // ==========================================
    // ğŸ—ºï¸ åœ°å›¾é€»è¾‘ (Mapbox)
    // ==========================================
    mapboxgl.accessToken = 'pk.eyJ1Ijoiamh3MTExIiwiYSI6ImNtazgybjFyeDFidGczY29laWRtemFkMnoifQ.y1ffbT2LMx4jc8ZT8u9xXg';

    let map;
    let isDrawing = false, drawMode = false, pathCoordinates = [], stopsData = [];
    const statusBar = document.getElementById('status-bar');

<!--    async function initApp() {-->
<!--        renderForm(); // åˆå§‹åŒ–è¡¨å•-->

<!--        let config = null;-->
<!--        if (window.fetchSurveyConfig) {-->
<!--            config = await window.fetchSurveyConfig();-->
<!--        }-->

<!--        if (config) {-->
<!--            console.log("Configuration loaded:", config);-->

<!--            // -&#45;&#45; æ£€æŸ¥ä»Šæ—¥æ˜¯å¦å·²å¡«å†™ -&#45;&#45;-->
<!--            if (config.enabledDailyLimit) {-->
<!--                const todayStr = new Date().toISOString().split('T')[0];-->
<!--                const lastSubmitDate = localStorage.getItem('survey_last_submit_date');-->

<!--                if (lastSubmitDate === todayStr) {-->
<!--                    document.getElementById('submitted-mask').style.display = 'flex';-->
<!--                    document.body.style.overflow = 'hidden';-->
<!--                    return;-->
<!--                }-->
<!--            }-->

<!--            // æ£€æŸ¥é—®å·æ˜¯å¦å¼€æ”¾-->
<!--            if (config.isSurveyOpen === false) {-->
<!--                document.getElementById('closed-mask').style.display = 'flex';-->
<!--                document.body.style.overflow = 'hidden';-->
<!--                return;-->
<!--            }-->

<!--            // æ˜¾ç¤ºå…¬å‘Š-->
<!--            if (config.announcement) {-->
<!--                const banner = document.getElementById('announcement-bar');-->
<!--                banner.innerText = "ğŸ“¢ " + config.announcement;-->
<!--                banner.style.display = 'block';-->
<!--            }-->
<!--        }-->

<!--        // ç¡®å®šåœ°å›¾æ ·å¼-->
<!--        let mapStyleUrl = 'mapbox://styles/mapbox/streets-v11';-->
<!--        if (config && config.mapStyle) {-->
<!--            if (config.mapStyle === 'light') {-->
<!--                mapStyleUrl = 'mapbox://styles/mapbox/light-v10';-->
<!--            } else if (config.mapStyle.startsWith('mapbox://')) {-->
<!--                mapStyleUrl = config.mapStyle;-->
<!--            }-->
<!--        }-->

<!--        map = new mapboxgl.Map({-->
<!--            container: 'map',-->
<!--            style: mapStyleUrl,-->
<!--            center: [114.16, 22.285],-->
<!--            zoom: 13,-->
<!--            pitch: 0,-->
<!--        });-->

<!--        map.on('load', () => {-->
<!--            map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });-->
<!--            map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#e74c3c', 'line-width': 5, 'line-opacity': 0.8 } });-->
<!--            statusBar.innerText = "Ready";-->

<!--            // åˆå§‹åŒ–æ—¶è®¾ç½®åœ°å›¾è¯­è¨€-->
<!--            updateMapLanguage(currentLang);-->

<!--            setupMapInteractions();-->
<!--        });-->
<!--    }-->

    // ==========================================
    // ğŸ› ï¸ ä¿®æ”¹ä½ç½® 2ï¼šé¡µé¢åŠ è½½æ—¶çš„å¼ºåŠ›æ£€æŸ¥
    // ==========================================

    // 1. ç«‹å³æ‰§è¡Œæ£€æŸ¥ (IIFE) - æ”¾åœ¨è„šæœ¬æœ€å‰é¢
    (function() {
        const lastSubmitDate = localStorage.getItem('survey_last_submit_date');
        const todayStr = getLocalTodayDate(); // ä½¿ç”¨ç»Ÿä¸€å‡½æ•°

        if (lastSubmitDate === todayStr) {
            // å¦‚æœæœ¬åœ°å­˜çš„æ—¥æœŸä¹Ÿæ˜¯ä»Šå¤©ï¼Œå¼ºåˆ¶æ˜¾ç¤ºå·²æäº¤é®ç½©
            // ç­‰å¾… DOM è§£æå®Œæˆåç«‹å³æ‰§è¡Œ
            window.addEventListener('DOMContentLoaded', () => {
                const mask = document.getElementById('submitted-mask');
                const sidebar = document.getElementById('sidebar');
                const mapDiv = document.getElementById('map');

                if (mask) mask.style.display = 'flex';
                if (sidebar) sidebar.style.display = 'none'; // å½»åº•éšè—ä¾§è¾¹æ 
                if (mapDiv) mapDiv.style.display = 'none';   // å½»åº•éšè—åœ°å›¾
                document.body.style.overflow = 'hidden';     // ç¦æ­¢æ»šåŠ¨
            });
        }
    })();

    // 2. ä¿®æ”¹ initApp ä¸­çš„æ£€æŸ¥é€»è¾‘
    async function initApp() {
        // --- æ–°å¢ï¼šå†æ¬¡æ£€æŸ¥æœ¬åœ°ç¼“å­˜ ---
        const lastSubmitDate = localStorage.getItem('survey_last_submit_date');
        const todayStr = getLocalTodayDate();

        if (lastSubmitDate === todayStr) {
            console.log("ä»Šæ—¥å·²æäº¤ï¼Œåœæ­¢åˆå§‹åŒ–ã€‚");
            document.getElementById('submitted-mask').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
            return; // â›”ï¸ ç›´æ¥ç»ˆæ­¢åç»­ä»£ç ï¼ˆä¸åŠ è½½é…ç½®ï¼Œä¸åŠ è½½åœ°å›¾ï¼‰
        }
        // ---------------------------

        renderForm(); // åˆå§‹åŒ–è¡¨å•

        // ç­‰å¾… Firebase module åŠ è½½å®Œæ¯•
        let config = null;
        if (window.fetchSurveyConfig) {
            config = await window.fetchSurveyConfig();
        }

        // 3.1 å¤„ç†é…ç½®é€»è¾‘
        if (config) {
            console.log("Configuration loaded:", config);

            // --- âœ¨ æ¯æ—¥é™åˆ¶æ£€æŸ¥é€»è¾‘ (ä¿®å¤æ—¶åŒºç‰ˆ) ---
            // ç¡®ä¿å¼€å…³å¼€å¯
            const isLimitEnabled = config.enabledDailyLimit === true || config.enabledDailyLimit === "true";

            if (isLimitEnabled) {
                // è·å–æœ¬åœ°æ—¶é—´ (è§£å†³ UTC æ—¶å·®é—®é¢˜)
                const d = new Date();
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                const todayStr = `${year}-${month}-${day}`; // æ ¼å¼ï¼š2026-01-16

                const lastSubmitDate = localStorage.getItem('survey_last_submit_date');

                console.log(`Limit Check: Today=${todayStr}, Last=${lastSubmitDate}`);

                if (lastSubmitDate === todayStr) {
                    // å¦‚æœè®°å½•çš„æ—¥æœŸæ˜¯ä»Šå¤©ï¼Œæ˜¾ç¤ºæ„Ÿè°¢å±‚
                    document.getElementById('submitted-mask').style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    return; // â›”ï¸ åœæ­¢åŠ è½½
                }
            }
            // ------------------------------------

            // æ£€æŸ¥é—®å·æ˜¯å¦å¼€æ”¾
            if (config.isSurveyOpen === false) {
                document.getElementById('closed-mask').style.display = 'flex';
                document.body.style.overflow = 'hidden';
                return;
            }

            // æ˜¾ç¤ºå…¬å‘Š
            if (config.announcement) {
                const banner = document.getElementById('announcement-bar');
                banner.innerText = "ğŸ“¢ " + config.announcement;
                banner.style.display = 'block';
            }
        }

        // 3.2 ç¡®å®šåœ°å›¾æ ·å¼
        let mapStyleUrl = 'mapbox://styles/mapbox/streets-v11';
        if (config && config.mapStyle) {
            if (config.mapStyle === 'light') {
                mapStyleUrl = 'mapbox://styles/mapbox/light-v10';
            } else if (config.mapStyle.startsWith('mapbox://')) {
                mapStyleUrl = config.mapStyle;
            }
        }

        // 3.3 åˆå§‹åŒ–åœ°å›¾
        map = new mapboxgl.Map({
            container: 'map',
            style: mapStyleUrl,
            center: [114.16, 22.285],
            zoom: 13,
            pitch: 0,
        });

        map.on('load', () => {
            map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
            map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#e74c3c', 'line-width': 5, 'line-opacity': 0.8 } });
            statusBar.innerText = "Ready";

            updateMapLanguage(currentLang);
            setupMapInteractions();
        });
    }

    function setupMapInteractions() {
        // ç»˜å›¾æ¨¡å¼åˆ‡æ¢
        document.getElementById('btn-draw').addEventListener('click', () => {
            drawMode = true; map.dragPan.disable();
            document.getElementById('map').classList.add('cursor-pen');
            document.getElementById('btn-draw').style.display = 'none';
            document.getElementById('btn-clear').style.display = 'inline-block';
            statusBar.innerText = currentLang === 'en' ? "Drawing Mode: Drag to draw path" : (currentLang === 'zh-cn' ? "ç»˜ç”»æ¨¡å¼ï¼šè¯·æŒ‰ä½é¼ æ ‡/æ‰‹æŒ‡ç”»å‡ºæ‚¨çš„è¡Œèµ°è·¯çº¿" : "ç¹ªç•«æ¨¡å¼ï¼šè«‹æŒ‰ä½æ»‘é¼ /æ‰‹æŒ‡ç•«å‡ºæ‚¨çš„è¡Œèµ°è·¯ç·š");
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            pathCoordinates = []; stopsData = [];
            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } });
            document.querySelectorAll('.mapboxgl-marker').forEach(m => m.remove());
            document.getElementById('stops-list').innerHTML = '';
            document.getElementById('stops-container').style.display = 'none';

            drawMode = false; map.dragPan.enable();
            document.getElementById('map').classList.remove('cursor-pen');
            document.getElementById('btn-draw').style.display = 'inline-block';
            document.getElementById('btn-clear').style.display = 'none';
            statusBar.innerText = currentLang === 'en' ? "Cleared" : (currentLang === 'zh-cn' ? "å·²æ¸…é™¤" : "å·²æ¸…é™¤");
        });

        // é¼ æ ‡/è§¦æ‘¸ ç”»çº¿é€»è¾‘
        function handleMove(coords) {
            if (!drawMode || !isDrawing) return;
            pathCoordinates.push(coords);
            map.getSource('route').setData({ 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': pathCoordinates } });
        }

        map.on('mousedown', (e) => { if(drawMode) { isDrawing = true; pathCoordinates = [[e.lngLat.lng, e.lngLat.lat]]; } });
        map.on('mousemove', (e) => handleMove([e.lngLat.lng, e.lngLat.lat]));
        map.on('mouseup', () => endDraw());

        map.getCanvas().addEventListener('touchstart', (e) => {
            if (!drawMode) return; e.preventDefault();
            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
            isDrawing = true; pathCoordinates = [[loc.lng, loc.lat]];
        }, {passive:false});

        map.getCanvas().addEventListener('touchmove', (e) => {
            if (!drawMode) return; e.preventDefault();
            const loc = map.unproject([e.touches[0].clientX, e.touches[0].clientY]);
            handleMove([loc.lng, loc.lat]);
        }, {passive:false});

        map.getCanvas().addEventListener('touchend', () => endDraw());

        function endDraw() {
            if (!isDrawing) return;
            isDrawing = false; drawMode = false; map.dragPan.enable();
            document.getElementById('map').classList.remove('cursor-pen');

            if(pathCoordinates.length > 2) {
                const simplified = turf.simplify(turf.lineString(pathCoordinates), {tolerance: 0.0001, highQuality: true});
                pathCoordinates = simplified.geometry.coordinates;
                map.getSource('route').setData(simplified);
            }
            statusBar.innerText = currentLang === 'en'
                ? "Path generated. Click on the path to mark stops."
                : (currentLang === 'zh-cn' ? "è·¯å¾„å·²ç”Ÿæˆï¼Œè¯·ç‚¹å‡»è·¯å¾„ä¸Šçš„ç‚¹æ ‡è®°ç»è¿‡åŒºåŸŸæˆ–åœç•™ç‚¹" : "è·¯å¾‘å·²ç”Ÿæˆï¼Œè«‹é»æ“Šè·¯å¾‘ä¸Šçš„é»æ¨™è¨˜ç¶“éå€åŸŸæˆ–åœç•™é»");
        }

        // ==========================================
        // ğŸ“ æ¨™è¨˜åœç•™é»é‚è¼¯
        // ==========================================
        map.on('click', (e) => {
            if (drawMode || pathCoordinates.length === 0) return;

            const pt = turf.point([e.lngLat.lng, e.lngLat.lat]);
            const line = turf.lineString(pathCoordinates);
            const dist = turf.pointToLineDistance(pt, line, {units: 'kilometers'});

            if (dist > 0.2) {
                statusBar.innerText = currentLang === 'en' ? "âš ï¸ Please click near your path" : (currentLang === 'zh-cn' ? "âš ï¸ è¯·ç‚¹å‡»è·¯å¾„é™„è¿‘çš„ç‚¹" : "âš ï¸ è«‹é»æ“Šè·¯å¾‘é™„è¿‘çš„é»");
                return;
            }

            // 1. è¾“å…¥åœ°ç‚¹
            const promptName = currentLang === 'en' ? "Location Name/Activity:" : (currentLang === 'zh-cn' ? "åœ°ç‚¹åç§°/æ´»åŠ¨ (ä¾‹å¦‚: ä¸­å±±å…¬å›­/ä¼‘æ¯):" : "åœ°é»åç¨±/æ´»å‹• (ä¾‹å¦‚: ä¸­å±±å…¬åœ’/ä¼‘æ¯):");
            const name = prompt(promptName);
            if (!name) return;

            // 2. é€‰æ‹©æ—¶é—´
            let durationPrompt;
            if (currentLang === 'en') {
                durationPrompt = "Stay Duration:\n1: 0-10min\n2: 10-20min\n3: 20-30min\n4: 30+min\n(Please enter 1, 2, 3, or 4)";
            } else if (currentLang === 'zh-cn') {
                durationPrompt = "è¯·é€‰æ‹©åœç•™æ—¶é—´ï¼š\n1: 0-10åˆ†é’Ÿ\n2: 10-20åˆ†é’Ÿ\n3: 20-30åˆ†é’Ÿ\n4: 30åˆ†é’Ÿä»¥ä¸Š\n(è¯·è¾“å…¥æ•°å­— 1-4)";
            } else {
                durationPrompt = "è«‹é¸æ“‡åœç•™æ™‚é–“ï¼š\n1: 0-10åˆ†é˜\n2: 10-20åˆ†é˜\n3: 20-30åˆ†é˜\n4: 30åˆ†é˜ä»¥ä¸Š\n(è«‹è¼¸å…¥æ•¸å­— 1-4)";
            }

            const durChoice = prompt(durationPrompt, "1");

            const durMap = { "1": "0-10min", "2": "10-20min", "3": "20-30min", "4": "30+min" };
            const duration = durMap[durChoice] || "0-10min";

            // 3. æ ‡è®°
            new mapboxgl.Marker({ color: '#2ecc71' }).setLngLat(e.lngLat).addTo(map);
            stopsData.push({
                lng: e.lngLat.lng,
                lat: e.lngLat.lat,
                name: name,
                duration: duration
            });

            document.getElementById('stops-container').style.display = 'block';
            const div = document.createElement('div');
            div.className = 'stop-item';
            div.style.flexDirection = 'column';
            div.style.alignItems = 'flex-start';

            const stayedText = currentLang === 'en' ? 'Stayed' : 'åœç•™';
            div.innerHTML = `
                <div style="font-weight:bold;">ğŸ“ ${name}</div>
                <div style="font-size:11px; color:#28a745;">â±ï¸ ${stayedText}: ${duration}</div>
            `;
            document.getElementById('stops-list').appendChild(div);

            statusBar.innerText = currentLang === 'en' ? "Stop added" : (currentLang === 'zh-cn' ? "åœç•™ç‚¹å·²æ ‡è®°" : "åœç•™é»å·²æ¨™è¨˜");
        });
    }

    // å¯åŠ¨
    setTimeout(initApp, 500);

    // ==========================================
    // æäº¤é€»è¾‘
    // ==========================================
    document.getElementById('btn-submit').addEventListener('click', async () => {
        const btn = document.getElementById('btn-submit');
        const formData = {};

        document.querySelectorAll('input:checked').forEach(input => {
            const name = input.name;
            const val = input.value;
            if (formData[name]) {
                if (!Array.isArray(formData[name])) formData[name] = [formData[name]];
                formData[name].push(val);
            } else {
                formData[name] = val;
            }
        });

        if (pathCoordinates.length === 0) {
            alert(currentLang === 'en'
                ? "Please draw your route on the map!"
                : (currentLang === 'zh-cn' ? "è¯·åœ¨ç¬¬ä¸‰éƒ¨åˆ†ç»˜åˆ¶æ‚¨çš„è¡Œèµ°è·¯çº¿ï¼" : "è«‹åœ¨ç¬¬ä¸‰éƒ¨åˆ†ç¹ªè£½æ‚¨çš„è¡Œèµ°è·¯ç·šï¼"));
            return;
        }

        btn.disabled = true; btn.innerText = "...";

        const result = await window.submitToFirebase({
            answers: formData,
            path: JSON.stringify(pathCoordinates),
            stops: stopsData,
            timestamp: new Date().toISOString(),
            lang: currentLang
        });

<!--        if (result.success) {-->
<!--            const todayStr = new Date().toISOString().split('T')[0];-->
<!--            localStorage.setItem('survey_last_submit_date', todayStr);-->

<!--            alert("æäº¤æˆåŠŸ / Submitted Successfully! ID: " + result.id);-->
<!--            location.reload();-->
<!--        } else {-->
<!--            alert("Error: " + result.error);-->
<!--            btn.disabled = false; btn.innerText = "Retry";-->
<!--        }-->
        if (result.success) {
            // âœ… 1. è®°å½•ä»Šå¤©å·²æäº¤
            const todayStr = getLocalTodayDate();
            localStorage.setItem('survey_last_submit_date', todayStr);

            // âœ… 2. éšè—é—®å·å’Œåœ°å›¾ï¼Œæ˜¾ç¤ºæ„Ÿè°¢é®ç½© (ç›´æ¥æ“ä½œ DOMï¼Œä¸åˆ·æ–°!)
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('map').style.display = 'none';
            document.getElementById('submitted-mask').style.display = 'flex';

            // å¯é€‰ï¼šå¼¹çª—æç¤ºï¼ˆä¹Ÿå¯ä»¥å»æ‰ï¼Œå› ä¸ºé®ç½©å·²ç»å¾ˆæ˜æ˜¾äº†ï¼‰
            // alert("æäº¤æˆåŠŸ / Submitted Successfully! ID: " + result.id);

            // âŒ é‡ç‚¹ï¼šåˆ æ‰ä¸‹é¢è¿™è¡Œä»£ç ï¼ä¸è¦ reloadï¼
            // location.reload();

        } else {
            alert("Error: " + result.error);
            btn.disabled = false; btn.innerText = "Retry";
        }
    });
</script>
</body>
</html>
